	<!DOCTYPE html>
	 
			 
			
			<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><!--<![endif]-->
<head>
            <!-- Google tag (gtag.js) -->
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9TZ7D6NG2"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-S9TZ7D6NG2', {
            'cmx_page_type': 'Landing Page',
            'cmx_account_name': 'rbishop007'
        });
        </script>
        
    	
                                                 
                                                                                     
                 
                <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
        <title>Set Your Document Free</title>
        <meta name="keywords" content="">
        <meta name="author" content="">
        <meta name="description" content="This eBook discusses the challenges faced by organizations in extracting and analyzing data from documents. It also highlights the benefits of using intelligent document processing (IDP) powered by machine learning (ML) to overcome these challenges." />
        <meta property="og:title" content="Set Your Document Free" />
        <meta property="og:description" content="This eBook discusses the challenges faced by organizations in extracting and analyzing data from documents. It also highlights the benefits of using intelligent document processing (IDP) powered by machine learning (ML) to overcome these challenges." />
                    <meta property="og:image" content="https://contentmx.com/p/user/a_2967/media/Set-your-document-free_AWS_Pub_Sector_thumb.jpg" />
                <meta property="og:type" content="website" />

        <!--- Twitter Card Information -->
                    <meta name="twitter:card" content="summary">
                <meta name="twitter:title" content="Set Your Document Free">
                    <meta name="twitter:description" content="This eBook discusses the challenges faced by organizations in extracting and analyzing data from documents. It also highlights the benefits of using intelligent document processing (IDP) powered by machine learning (ML) to overcome these challenges.">
                <meta name="twitter:image" content="https://fe5e0932bbdbee188a67-ade54de1bba9a4fe61c120942a09245b.ssl.cf1.rackcdn.com/Set-your-document-free_AWS_Pub_Sector_thumb.jpg">
    
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery.min.js?v=3.2"></script>
	<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/bootstrap.min.js"></script>
<link type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/jquery-ui-1.12.1.min.css?v=3.2" rel="stylesheet" />
<link type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/fontawesome-6-4-0-web/css/fontawesome.min.css?v=3.2" rel="stylesheet" />
<link type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/fontawesome-6-4-0-web/css/brands.min.css?v=3.2" rel="stylesheet" />
<link type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/fontawesome-6-4-0-web/css/solid.min.css?v=3.2" rel="stylesheet" />
<link type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/bootstrap-3-4-1/css/bootstrap.min.css?v=3.2" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/p/templates/microsite-vendor-library/stylesheets/style.css?v=3.2">
<link type="text/css" href="/p/templates/microsite-vendor/local.css?v=3.2" rel="stylesheet" />
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery-ui-1.12.1.min.js"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery.transit.js?v=3.2"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery.doubletaptogo.js?v=3.2"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery-waypoints.js?v=3.2"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery.flexslider.js?v=3.2"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/main.js?v=3.2"></script>
<script type="text/javascript" src="/p/templates/microsite-vendor-library/javascript/jquery-delaytext.js?v=3.2"></script>
<style>

</style>


    <script src="/b/lib/js/js.cookie.min.js"></script>
    <script type="text/javascript">

    var visitor_access_config = {};
    //must be called before the document.ready to not let the url to be clicked before dom structure is loaded
    prepareAccessLevelContorls(); 
    
    var init_data = {};
    init_data.is_init = 1;
    
    if (window.addEventListener) {
        window.addEventListener("message", onMessage, false);        
    } 
    else if (window.attachEvent) {
        window.attachEvent("onmessage", onMessage, false);
    }
    //the oauth2 child window listener + the child iframe listener
    function onMessage(e){
        try{
            var data = JSON.parse(e.data);
        }catch(e){
            //any other message (for example google captcha)
            return;
        }
        if (e.origin == 'https://contentmx.com' && data.command == 'oauth2_connect_result') {
            window.document._SignInFinished=1; 
            if(data.data.result=='success'){
                //the SignIn has happened here

                //before closing the signin lets try to get go_to from there
                var go_to = $('#visitor_signin_dialog_temp').find('input[name="go_to"]').val();
                signin_dialog_close();  

                var expires = new Date(1744482177000);
                if(data.data.cmxvisitor!=undefined){
                    Cookies.set('cmxvisitor', data.data.cmxvisitor , {expires: expires, path: '/',  domain: '.contentmx.com' , sameSite: 'None', secure: true });
                }
                if(data.data.cmxvisitorsignedin!=undefined){
                    Cookies.set('cmxvisitorsignedin', data.data.cmxvisitorsignedin , {expires: expires, path: '/',  domain: '.contentmx.com' , sameSite: 'None', secure: true });
                }

                if(data.data.connection_type=='google'){
                    clearGoogleOneTapCookie();
                }

                params = {};
                if(go_to != undefined && go_to != ''){
                    params.callback = function(){
                        if (typeof update_download_links === "function") {
                            update_download_links();
                        }
                        displayVisitorInformationActionDialog('<h1 style="margin-top: 0px;">Success!</h1>You will be redirected in a moment...',go_to);
                        setTimeout("information_action_dialog_close();", 3000);
                        return;
                    }
                }
                checkCMXVisitor('check_cmx_visitor',{},params);
            }
            if(data.data.result=='error'){
                showSignInError(decodeURIComponent(data.data.error.replace(/\+/g, ' ')));
            }
        }
    
    }

    $(document).ready(function(){
        //this code runs when the page dom structure is ready
    
        checkCMXVisitor('check_cmx_visitor',init_data);
           
    });

    $(document).on('click','.signoutVisitor',function(){
        //the SignOut has happened here
        var params = {};
        params.display_google_one_tap = 1;
        checkCMXVisitor('logout_cmx_visitor',{},params);
    });


    $(document).on('click','#submit_visitor_optin',function(e){
        e.preventDefault();
        var form = $(this).closest('form');
        $.ajax('https://contentmx.com/b/page/page_visitor_connect.php', {
            type : 'POST',
            data : form.serialize(),
            beforeSend: function(){
            },
            success : function (response) {
                response = jQuery.parseJSON(response);
                if(response.result == 'success'){
                    $('#visitor_optin_dialog_temp').find('#visitor_optin_error').hide();
                    /*
                    if(!jQuery.isEmptyObject(response.sync_commands)){
                        params.sync_commands = response.sync_commands;
                    }
                    */
                    var params = {};
                    if(response.force_capture != undefined && response.force_capture == 1){
                        params.force_capture = 1;
                        params.callback = function(){
                            //!!!! TEST THIS IN CAPTURE PAGE !!!!!
                            optin_dialog_close();
                            displayVisitorInformationActionDialog(response.title); //no go to when force_capture==1
                            setTimeout("information_action_dialog_close();", 3000);
                        }
                    }else{
                        params.callback = function(){
                            optin_dialog_close();
                            displayVisitorInformationActionDialog(response.title,response.go_to);
                            setTimeout("information_action_dialog_close();", 3000);
                        }
                    }
                    //run without init params
                    checkCMXVisitor('check_cmx_visitor', {}, params);
                }
                if( response.result == 'identification_required'){
                    $('#visitor_optin_dialog_temp').find('#visitor_optin_error').hide();
                    optin_dialog_close();
                    displayVisitorInformationActionDialog(response.title/*,response.go_to*/); //no go_to , go_to will work when visitor will identify himself
                }
                if(response.result == 'error'){
                    showOptInError(response.error);
                }
            },
            error :  function(xhr, str){
                showOptInError(xhr.statusText);
            }
        });
    });

    $(document).on('click','#submit_visitor_confirm_identity',function(e){
        e.preventDefault();
        var form = $(this).closest('form');
        var check = form.find('input[name="confirm_identity_visitor_email"]').val();
        $.ajax('https://contentmx.com/b/page/page_visitor_connect.php', {
            type : 'POST',
            data : form.serialize(),
            beforeSend: function(){
            },
            success : function (response) {
                response = jQuery.parseJSON(response);
                if(response.result == 'error'){
                    showVisitorConfirmIdentityError(response.error);
                }else{
                    confirm_identity_dialog_close();
                    if(response.result == 'already_confirmed'){
                        displayVisitorInformationActionDialog(response.title,response.go_to);
                        setTimeout("information_action_dialog_close();", 3000);
                    }
                    if(response.result == 'email_sent'){
                        displayVisitorInformationActionDialog(response.title/*,response.go_to*/);//no go_to , go_to will work when visitor will confirm email
                    }
                }
            },
            error :  function(xhr, str){
                showVisitorConfirmIdentityError(xhr.statusText);
            }
        });
    });
    

    function showSignInError(error){
        $('#visitor_signin_dialog_temp').find('#visitor_signin_error').html(error).show();
    }
    function showOptInError(error){
        $('#visitor_optin_dialog_temp').find('#visitor_optin_error').html(error).show();
    }
    function showVisitorConfirmIdentityError(error){
        $('#visitor_confirm_identity_dialog_temp').find('#visitor_confirm_identity_error').html(error).show();
    }

    function processGoogleOneTapToken(response){
        if(response.credential!=undefined){
            //the SignIn has happened here
            checkCMXVisitor('google_single_tap_connect', {}, response);
			if (typeof update_download_links === "function") {
				update_download_links();
			}
        }
    }

    function clearGoogleOneTapCookie(){
        Cookies.remove('g_state', { path: '/', domain: '.contentmx.com' });
    }
    function setStorageAccessCookieDeclined(){
        Cookies.set('cmxstorageaccessgranted', 0 , {expires: 180, path: '/', domain: '.contentmx.com' });
    }
    function setStorageAccessCookieAccepted(){
        Cookies.set('cmxstorageaccessgranted', 1 , {expires: 180, path: '/', domain: '.contentmx.com' });
    }
    function getStorageAccessCookie(){
        return Cookies.get('cmxstorageaccessgranted');
    }
    function clearStorageAccessCookie(){
        Cookies.remove('cmxstorageaccessgranted', { path: '/', domain: '.contentmx.com' });
    }

    //the main function to run the check visitor ajax call
    function checkCMXVisitor(action, init_params, params){
        var is_init = 0;
        if(init_params != undefined && init_params.is_init != undefined && init_params.is_init == 1){
            is_init = 1;
        }
        var data = {};
        var force_capture = 0;
        var callback = undefined;
        if(action==undefined){
            data.action='check_cmx_visitor';
        }else{
            data.action = action;
        }
        if(is_init == 1){
            data.display_google_one_tap = 1;
        }
        if(init_params != undefined && !jQuery.isEmptyObject(init_params) ){
            if(init_params.local_m_id != undefined){
                data.local_m_id = init_params.local_m_id;
            }
            if(init_params.master_cmxvisitor != undefined){
                data.master_cmxvisitor = init_params.master_cmxvisitor;
            }
            if(init_params.master_cmxvisitorsignedin != undefined){
                data.master_cmxvisitorsignedin = init_params.master_cmxvisitorsignedin;
            }
            if(init_params.master_cmxuser != undefined){
                data.master_cmxuser = init_params.master_cmxuser;
            }
            if(init_params.master_cmxmember != undefined){
                data.master_cmxmember = init_params.master_cmxmember;
            }       
            if(init_params.uuid != undefined){
                data.uuid = init_params.uuid;
            }     
            if(init_params.cc != undefined){
                data.cc = init_params.cc;
            }     
            if(init_params.time != undefined){
                data.time = init_params.time;
            }     
            if(init_params.go_to != undefined){
                data.go_to = init_params.go_to;
            }  
            if(init_params.ownership_proof != undefined){
                data.ownership_proof = init_params.ownership_proof;
            }    
        }
        if(params != undefined){
            if(params.display_google_one_tap != undefined){
                data.display_google_one_tap = params.display_google_one_tap;
            }
            if(params.credential != undefined){
                data.credential = params.credential;
            }
            if(params.force_capture != undefined){
                force_capture = params.force_capture;
            }
            if(params.callback != undefined){
                callback = params.callback;
            }
        }
        $.ajax('https://contentmx.com/b/page/page_visitor_connect.php', {
            type : 'POST',
            data : data,
            beforeSend: function(){
                $('.visitor_login_box_loading').show();
            },
            success : function (response) {
                response = jQuery.parseJSON(response);

                //setup visitor_access_config
                visitor_access_config.is_identified = response.visitorIsIdentified;
                visitor_access_config.is_identified_confirmed = response.visitorisIdentifiedConfirmed;
                visitor_access_config.is_identified_opted_in = response.visitorisIdentifiedOptedIn;
                visitor_access_config.is_authorized= response.visitorIsAuthorized;
                visitor_access_config.is_signed_in = response.visitorisSignedIn;
                visitor_access_config.optin = response.visitor_optin;

                if(action=='check_cmx_visitor' && is_init == 1){
                    if(init_params.second_page_load == undefined || response.visitor_cookie_changed == true){
					    notifyPostVisitorCheck();
                    }
                    //seems to be the mostly correct place
                    prepareVisitorSignInDialog();
                    prepareVisitorOptInDialog();
                    prepareVisitorConfirmIdentityDialog();
                    prepareVisitorAuthorizeWindow();
                }
                if(!jQuery.isEmptyObject(response.sync_commands)){
                    var message = {};
                    message.command = 'sync_commands';
                    message.sync_commands = response.sync_commands;
                    postMessageToIframe(message);
                }
                $('.visitor_login_box').html(response.visitor_login_box_html);

                //SETUP CONFIRMATION DIV

                if($('div#visitor_confirmation_dialog').length>0 && response.visitorIsIdentified == 1){
                    $('div#visitor_confirmation_dialog').find('#confirmation_visitor_id').val(response.visitor_id);
                    $('div#visitor_confirmation_dialog').find('#confirmation_visitor_first_name').html(response.visitor_first_name);
                    $('div#visitor_confirmation_dialog').find('#confirmation_visitor_last_name').html(response.visitor_last_name);
                    $('div#visitor_confirmation_dialog').find('#confirmation_visitor_email').html(response.visitor_email);
                    if(response.visitor_optin==1){
                        $('div#visitor_confirmation_dialog').find('[name="confirmation_visitor_optin"]').prop('checked',true);
                    }else{
                        $('div#visitor_confirmation_dialog').find('[name="confirmation_visitor_optin"]').prop('checked',false);
                    }
                    prepareVisitorConfirmationDialog(force_capture);
                }

                //END SETUP

                //SETUP MANUAL OPTIN WINDOW

                $('div#visitor_optin_dialog').find('input[name="optin_visitor_first_name"]').val(response.visitor_first_name);
                $('div#visitor_optin_dialog').find('input[name="optin_visitor_last_name"]').val(response.visitor_last_name);
                $('div#visitor_optin_dialog').find('input[name="optin_visitor_email"]').val(response.visitor_email);
                if(response.visitor_optin==1){
                    $('div#visitor_optin_dialog').find('input[name="optin_visitor_optin"]').prop('checked',true);
                }else{
                    $('div#visitor_optin_dialog').find('input[name="optin_visitor_optin"]').prop('checked',false);
                }

                //END SETUP

                //SETUP CONFIRM IDENTITY WINDOW

                $('div#visitor_confirm_identity_dialog').find('b#confirm_identity_visitor_email').html(response.visitor_email);
                $('div#visitor_confirm_identity_dialog').find('input[name="confirm_identity_visitor_email"]').val(response.visitor_email);
                
                //END SETUP
                
                //SETUP INFORMATION ACTION DIALOG - IN THE VERY END

                if(response.email_confirmation_result != undefined ){
                    if( response.email_confirmation_result == 'success'){
                        close_all();
                        displayVisitorInformationActionDialog(response.title,response.go_to);
                    }
                    if( response.email_confirmation_result == 'error'){
                        close_all();
                        displayVisitorInformationActionDialog(response.title,'http://contentmx.com/b/page/page.php?u=rbishop007&i=3956871#');
                    }
                }

                //END SETUP

                //IT IS TIME FOR CALLBACK
                if(callback != undefined){
                    //console.log(callback);
                    callback();
                }
                //END

            },
            error :  function(xhr, str){
            }
        });
    }

    function postMessageToIframe(message){
        if(document.querySelector("iframe#grant_storage_access_api_iframe") && getStorageAccessCookie()==1 ){
            document.querySelector("iframe#grant_storage_access_api_iframe").contentWindow.postMessage(JSON.stringify(message), 'https://contentmx.com');
        }
    }

    function signin_dialog_close(){
		$('#visitor_signin_dialog_temp').remove();
		$('#visitor_modal_underlay_temp').remove();
    }

    function optin_dialog_close(){
		$('#visitor_optin_dialog_temp').remove();
		$('#visitor_modal_underlay_temp').remove();
    }

    function confirm_identity_dialog_close(){
		$('#visitor_confirm_identity_dialog_temp').remove();
		$('#visitor_modal_underlay_temp').remove();
    }

    function information_action_dialog_close(){
        var go_to = $('#visitor_information_action_dialog_temp').find('input[name="go_to"]').val();
		$('#visitor_information_action_dialog_temp').remove();
		$('#visitor_modal_underlay_temp').remove();
        if(go_to != undefined && go_to != ''){
            window.location.href = go_to;//decodeURIComponent(go_to);
            return;
        }
    }

    function confirmation_dialog_remove(){
		$('#visitor_confirmation_dialog').remove();
        $('#promotion-lead-capture-form').find('.form-fields').show();
        $('#promotion-lead-capture-form').find('#lead-gen-form-button').show();
        $('#promotion-lead-capture-form').find('#member-optin-express-capture').show();
    }

    function close_all(){
        signin_dialog_close();
        optin_dialog_close();
        confirm_identity_dialog_close();
        information_action_dialog_close();
    }

	$(document).on('click','#visitor_modal_underlay_temp',function(){
		close_all();
	});

	
	function displayVisitorSignInDialog(msg, go_to) {
		$('#visitor_signin_dialog').find('#visitor_signin_error').hide();
		var visitor_modal = $('#visitor_signin_dialog').clone();
		var visitor_modal_underlay = $('#visitor_modal_underlay').clone();
		if (msg != undefined && msg != '') {
			$(visitor_modal).find('#visitor_modal_value_prop').html(msg);
		}
        if (go_to != undefined && go_to != '') {
			$(visitor_modal).find('input[name="go_to"]').val(go_to);
		}
		$(visitor_modal).attr('id','visitor_signin_dialog_temp').show();
		$(visitor_modal_underlay).attr('id','visitor_modal_underlay_temp').show();
		$('body').append(visitor_modal);
		$('body').append(visitor_modal_underlay);
		//$('#visitor_signin_dialog_temp')[0].scrollIntoView();
        $("html, body").animate({ scrollTop: 0 }, "fast");
	}

    function prepareVisitorSignInDialog() {
        $(document).on('click','.openLoginWindow',function(){
            var title_html = $(this).attr('title_html');
            var go_to = $(this).attr('go_to');
            if(go_to == undefined) go_to = '';
            displayVisitorSignInDialog(title_html,go_to);
        });
    }

    function displayVisitorOptInDialog(title_html,confirm_identity,go_to,require_optin) {
        $('#visitor_optin_dialog').find('#visitor_optin_error').hide();
        $('#visitor_optin_dialog').find('input[name="go_to"]').val('');
		var visitor_optin_modal = $('#visitor_optin_dialog').clone();
		var visitor_modal_underlay = $('#visitor_modal_underlay').clone();
		if (title_html != undefined && title_html != '') {
			$(visitor_optin_modal).find('#visitor_optin_modal_value_prop').html(title_html);
		}
        if (go_to != undefined && go_to != '') {
			$(visitor_optin_modal).find('input[name="go_to"]').val(go_to);
		}
        if (require_optin != undefined && require_optin == 1) {
			$(visitor_optin_modal).find('input[name="require_optin"]').val('1');
		}
        visitor_optin_modal.find('input[name="confirm_identity"]').val(confirm_identity);
		$(visitor_optin_modal).attr('id','visitor_optin_dialog_temp').show();
		$(visitor_modal_underlay).attr('id','visitor_modal_underlay_temp').show();
		$('body').append(visitor_optin_modal);
		$('body').append(visitor_modal_underlay);
		//$('#visitor_optin_dialog_temp')[0].scrollIntoView();
        $("html, body").animate({ scrollTop: 0 }, "fast");
	}


    function prepareVisitorOptInDialog(){
        $(document).on('click','.identify-optin',function(e){
            e.preventDefault();
            var confirm_identity = $(this).attr('confirm_identity');
            if(confirm_identity == undefined) confirm_identity = 0;
            var go_to = $(this).attr('go_to');
            if(go_to == undefined) go_to = '';
            var title_html = $(this).attr('title_html');
            displayVisitorOptInDialog(title_html,confirm_identity,go_to);
        });
    }

    function displayVisitorConfirmIdentityDialog(title_html,go_to) {
        $('#visitor_confirm_identity_dialog').find('#visitor_confirm_identity_error').hide();
        $('#visitor_confirm_identity_dialog').find('input[name="go_to"]').val('');
		var visitor_confirm_identity_modal = $('#visitor_confirm_identity_dialog').clone();
		var visitor_modal_underlay = $('#visitor_modal_underlay').clone();
		if (title_html != undefined && title_html != '') {
			$(visitor_confirm_identity_modal).find('#visitor_confirm_identity_modal_value_prop').html(title_html);
		}
        if (go_to != undefined && go_to != '') {
			$(visitor_confirm_identity_modal).find('input[name="go_to"]').val(go_to);
		}
		$(visitor_confirm_identity_modal).attr('id','visitor_confirm_identity_dialog_temp').show();
		$(visitor_modal_underlay).attr('id','visitor_modal_underlay_temp').show();
		$('body').append(visitor_confirm_identity_modal);
		$('body').append(visitor_modal_underlay);
		$('#visitor_confirm_identity_dialog_temp')[0].scrollIntoView();
        $("html, body").animate({ scrollTop: 0 }, "fast");
	}

    function prepareVisitorConfirmIdentityDialog(){
        $(document).on('click','.confirm-identity',function(e){
            e.preventDefault();
            var title_html = $(this).attr('title_html');
            var go_to = $(this).attr('go_to');
            if(go_to == undefined) go_to = '';
            if(visitor_access_config.is_identified == 1){
                displayVisitorConfirmIdentityDialog(title_html,go_to);
            }else{
                displayVisitorOptInDialog('',1,go_to);
            }
        });
    }

    function prepareVisitorAuthorizeWindow(){
        $(document).on('click','.signin-pop',function(){
            var auth_url = $(this).attr('data-url');
            window.document._SignInFinished = 0;
            //on bsse of $.oauthpopup
            window._oauthWindow = window.open(auth_url, 'Sign In' , 'location=0,status=0,width=400,height=600');

            $('.visitor_login_box_loading').show();
            
            window._oauthInterval = window.setInterval(function(){
                if (window._oauthWindow.closed) {
                    window.clearInterval(window._oauthInterval);
                    if(window.document._SignInFinished==0){
                        showSignInError('Sign In was interrupted by user.');
                    }
                    $('.visitor_login_box_loading').hide();
                }
            }, 1000);
        });
    }

    function prepareAccessLevelContorls(){
        $(document).on('click','a.access-level',function(e){
            
            var go_to = $(this).attr('href');
            var access_level = $(this).attr('access_level');
            if(access_level == undefined || access_level == ''){
                //in this case go on, do nothing
                //e.preventDefault();
                //alert('passed'); 
            }else{
                e.preventDefault();

                if(jQuery.isEmptyObject(visitor_access_config)){
                    //do not have required access level or not ready! - so do nothing
                }else{
                    //console.log(visitor_access_config);
                    var passed = 0;
                    if(access_level == 'identified'){
                        if(visitor_access_config.is_identified == 1){
                            passed = 1;
                        }else{
                            displayVisitorOptInDialog('',0,go_to);
                        }
                    }if(access_level == 'identified_opted_in'){
                        if(visitor_access_config.is_identified_opted_in == 1){
                            passed = 1;
                        }else{
                            displayVisitorOptInDialog('',0,go_to,1);
                        }
                    }else if(access_level == 'identified_confirmed'){
                        if(visitor_access_config.is_identified_confirmed == 1){
                            passed = 1;
                        }else{
                            if(visitor_access_config.is_identified == 1){
                                displayVisitorConfirmIdentityDialog('',go_to);
                            }else{
                                displayVisitorOptInDialog('',1,go_to);
                            }
                        }
                    }else if(access_level == 'authorized'){
                        if(visitor_access_config.is_authorized == 1){
                            passed = 1;
                        }else{
                            displayVisitorSignInDialog('',go_to);
                        }
                    }else if(access_level == 'signed_in'){
                        if(visitor_access_config.is_signed_in == 1){
                            passed = 1;
                        }else{
                            displayVisitorSignInDialog('',go_to);
                        }
                    }
                    /*
                    if(passed == 1){
                        alert('passed');
                    }
                    return;
                    */
                    //FINALY:
                    if(passed == 1){
                        window.location.href = go_to;
                        return;
                    }
                }
            }
        });
    }

    function displayVisitorInformationActionDialog(title_html,go_to) {
		var visitor_information_action_modal = $('#visitor_information_action_dialog').clone();
		var visitor_modal_underlay = $('#visitor_modal_underlay').clone();
		if (title_html != undefined && title_html != '') {
			$(visitor_information_action_modal).find('#visitor_information_action_modal_value_prop').html(title_html);
		}
        if (go_to != undefined && go_to != '') {
            $(visitor_information_action_modal).find('input[name="go_to"]').val(go_to);
        }
		$(visitor_information_action_modal).attr('id','visitor_information_action_dialog_temp').show();
		$(visitor_modal_underlay).attr('id','visitor_modal_underlay_temp').show();
		$('body').append(visitor_information_action_modal);
		$('body').append(visitor_modal_underlay);
		//$('#visitor_information_action_dialog_temp')[0].scrollIntoView();
        $("html, body").animate({ scrollTop: 0 }, "fast");
	}



    function prepareVisitorConfirmationDialog(force_capture){
        if($('#visitor_confirmation_dialog').length==1){
            var visitor_confirmation_modal = $('#visitor_confirmation_dialog');
            $('#promotion-lead-capture-form').find('.form-fields').after(visitor_confirmation_modal);
            if(force_capture == 0){
                $('#promotion-lead-capture-form').find('.form-fields').hide();
                $('#promotion-lead-capture-form').find('#lead-gen-form-button').hide();
                $('#promotion-lead-capture-form').find('#member-optin-express-capture').hide();
                visitor_confirmation_modal.show();
            }else{
                $('#promotion-lead-capture-form').find('#lead-gen-form-button').trigger('click');
            }
        }
	} 
	
	var postVisitorCallbacks = [];
	
	function addPostVisitorCallback(callback) {
		if (postVisitorCallbacks.indexOf(callback) < 0) {
			postVisitorCallbacks.push(callback);
		}
    }
    
    function removePostVisitorCallback(callback) {
		var index;
		if ((index = postVisitorCallbacks.indexOf(callback)) >= 0) {
			postVisitorCallbacks.splice(index, 1);
		}
	}

	function notifyPostVisitorCheck() {
		postVisitorCallbacks.forEach(function(callback){
			 callback(); 
		});
	} 

    </script>
	<style>
	#visitor_signin_dialog_temp{
		position: absolute;
		top: 50px;
		right: 0;
		left: 0;
		background: #fff;
		width: 100%;
		max-width: 500px;
		margin: 0 auto;
		padding: 30px;
		z-index: 9000;
		border: 1px solid #cccccc;
	}
    
	#visitor_modal_underlay_temp{
		position: fixed;
		top: 0;
		background-color: #fff;
		opacity: 0.6;
		height: 100%;
		width: 100%;
		z-index: 8000;
	}
	#visitor_modal_value_prop{
		padding: 20px 0;
		font-size: 14px;
	}
	#visitor_modal_logo{
		background: #11a0dc;
		padding: 15px 10px;
	}
	#visitor_modal_logo img{
		max-height: 50px;
		width: auto;
		height: auto;
		max-width: 200px;
	}
	#visitor_modal_close{
		position: absolute;
		top: 5px;
		right: 10px;
		color: #999999;
	}
	.signin-pop.visitor_microsoft{
		border:1px solid #ccc;
	}
	.signin-pop{
		height: 50px;
		display: flex;
		align-items: center;
		margin: 0 0 10px 0;
	}
	.signin-pop img{
		margin: 0 10px 0 5px;
	}
	.visitor_linkedin{
		background-color: #3378B2;
		text-decoration:none;
		color:#fff !important;
		font-size:12px;
	}
	a.visitor_linkedin:hover{
		text-decoration:none;
	}
	.visitor_linkedin img{
		max-height: 38px;
	}
	.visitor_google{
		background-color: #4285f4;
	}
	.visitor_login_box{
		display: flex;
		align-items: center;
		justify-content: center;
		border: 1px solid #fff;
		padding: 5px 10px 5px 5px;
        position: relative;
        height: 50px;
        z-index: 950;
	}
	.visitor_login_box img{	
		padding: 0px 10px 0px 0px;
	}
	.visitor_login_box .glyphicon-user{
		width: 45px;
		height: 45px;
		text-align: center;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.visitor_login_box .glyphicon-user:before {
		display: block;
		font-size: 30px;
	}
    .visitor_login_box_loading{
		width: 100%;
        height: 100%;
        background-color: #FFFFFF;
		opacity: 0.5;
        z-index: 1200;
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        text-align: center;
		align-items: center;
		justify-content: center;
        vertical-align: middle;
	}
	#branding .visitor_login_box_loading{
        z-index: 7;
	}
    .visitor_login_box_loading img{
        padding: 8px 0px 0px 0px;
    }
    .visitor_login_box .signin-button{
        margin: 0px 10px 0px 10px;
    }
    
    #storage-access-cookie-confirmation {
        background: #FFF;
        height: auto;
        left: 0;
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 262px !important;
        z-index: 2147483647 !important;
        background-color: #000000;
        border-bottom: 1px solid #000000;
        border-top: 1px solid #000000;
        box-shadow: 0 1px 5px #000000;
        position:fixed;
    }
    #storage-access-cookie-confirmation-inner {
        background:#000000;
        margin:0 auto;
        max-width:980px;
        padding:20px
        box-sizing:border-box!important
    }



    #visitor_optin_dialog_temp{
		position: absolute;
		top: 50px;
		right: 0;
		left: 0;
		background: #fff;
		width: 100%;
		max-width: 500px;
		margin: 0 auto;
		padding: 30px;
		z-index: 9000;
		border: 1px solid #cccccc;
	}
    #visitor_optin_modal_value_prop{
		padding: 20px 0;
		font-size: 14px;
	}

    #visitor_confirmation_dialog{
		background: #fff;
		width: 100%;
		max-width: 500px;
		margin: 0 auto;
		padding: 20px;
		border: 1px solid #cccccc;
        margin-top: 20px;
	}
    #visitor_confirmation_modal_value_prop{
		font-size: 14px;
	}

    #visitor_confirm_identity_dialog_temp{
		position: absolute;
		top: 50px;
		right: 0;
		left: 0;
		background: #fff;
		width: 100%;
		max-width: 500px;
		margin: 0 auto;
		padding: 30px;
		z-index: 9000;
		border: 1px solid #cccccc;
	}
    #visitor_confirm_identity_modal_value_prop{
		padding: 20px 0;
		font-size: 14px;
	}

    #visitor_information_action_dialog_temp{
		position: absolute;
		top: 50px;
		right: 0;
		left: 0;
		background: #fff;
		width: 100%;
		max-width: 500px;
		margin: 0 auto;
		padding: 30px;
		z-index: 9000;
		border: 1px solid #cccccc;
	}
    #visitor_information_action_modal_value_prop{
		padding: 20px 0;
		font-size: 14px;
	}


    
	</style>
	

</head>
<body class="css-2967  second-level-page">
		
		
	
		<div id="fixed-header-wrapper">
	
			<div class="partner_directory_menu_bar"><ul class="nav navbar-nav menu_bar_items"></ul><div  class="menu_bar_login"><div class="visitor_login_box"><span class="glyphicon glyphicon-user" aria-hidden="true"></span>  <span class='signin-button'><a href="#" class="openLoginWindow">Sign In</a></span><div class='visitor_login_box_loading'>
            <img width=32 src='/b/img/loading_sso.gif'>
        </div></div>
	<div id="visitor_signin_dialog" style="display:none">
		<a href='javascript:void(0);' onClick='signin_dialog_close();' id="visitor_modal_close"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
    	<!-- <div id="visitor_modal_logo">
			<img src="https://www.contentmx.com/wp-content/uploads/2018/10/partneron-white-logo-transparent.png">
		</div> -->
		<div id="visitor_modal_value_prop">
			<h1 style="margin-top: 0px;">The full experience is only one step away!</h1><br>Sign in to unlock valuable content and features from our AI-driven platform. Receive timely technology updates and the latest information from the solution providers who can help you realize your goals. 
		</div>
    	<div id="visitor_signin_error" class="alert alert-danger" role="alert" style="display:none"></div>
		<div id="visitor_login_options">
            <input type=hidden name="go_to" value="">
			<a href='javascript:void(0);' data-url="https://accounts.google.com/o/oauth2/auth?response_type=code&redirect_uri=https%3A%2F%2Fcontentmx.com%2Fb%2Fpage%2Fpage_visitor_connect.php&client_id=115257697105-7lsrsd0nb8nl29teotg87k3s6mdl6lvu.apps.googleusercontent.com&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile&access_type=offline&approval_prompt=force&enable_granular_consent=true&state=%2526connection_type%253Dgoogle%2526host%253Dcontentmx.com" class="signin-pop visitor_google"> <img src="https://contentmx.com/b/img/sign-in-with-google.png" alt="Sign in with Google"></a>
			<a href='javascript:void(0);' data-url="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?response_type=code&client_id=36f2ea2c-01ff-4025-bb4a-7dcb2a39ca4d&redirect_uri=https%3A%2F%2Fcontentmx.com%2Fb%2Fpage%2Fpage_visitor_connect.php&scope=user.read&response_mode=query&state=%2526connection_type%253Dmicrosoft%2526host%253Dcontentmx.com" class="signin-pop visitor_microsoft"> <img src="https://contentmx.com/p/img/ms-login.png" alt="Sign in with Microsoft"></a> 
			<a href='javascript:void(0);' data-url="https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=78qcm5yr3rfdwk&redirect_uri=https%3A%2F%2Fcontentmx.com%2Fb%2Fpage%2Fpage_visitor_connect.php&scope=r_basicprofile+r_emailaddress&state=%2526connection_type%253Dlinkedin%2526host%253Dcontentmx.com" class="signin-pop visitor_linkedin"> <img src="https://contentmx.com/p/img/login-linkedin-icon.png" alt="Sign in with LinkedIn"> Sign in with LinkedIn</a>
		</div>
    </div>



    <div id="visitor_optin_dialog" style="display:none">
		<a href='javascript:void(0);' onClick='optin_dialog_close();' id="visitor_modal_close"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>

        <div id="visitor_optin_modal_value_prop">
			<h1 style="margin-top: 0px;">Bubble Cloud/ Bubble Social Media Marketing is ready to help!</h1><br>Start your journey by entering your name and email address below: 
		</div>

        <div id="visitor_optin_error" class="alert alert-danger" role="alert" style="display:none"></div>


		<div id="visitor_optin_data">
            <form>
            <input type='hidden' name='action' value='visitor_optin'>

            <input type=hidden name='promotion_template_page' value=''>
            <input type=hidden name='member_id' value='0'>
            <input type=hidden name='promotion_id' value='0'>
            <input type=hidden name='instance_id' value='3956871'>
            <input type=hidden name='account_id' value='13818'>
            <input type=hidden name='origin_member_id' value='0'>
            <input type=hidden name='username' value='rbishop007'>
            <input type=hidden name='confirm_identity' value='0'>
            <input type=hidden name='require_optin' value='0'>
            <input type=hidden name='go_to' value=''>
            <input type=hidden name='confirmation_go_to' value='http://contentmx.com/b/page/page.php?u=rbishop007&amp;i=3956871'>

            <label for='optin_visitor_email'>Email</label>
            <input type='text' class='form-control capture-field long' name='optin_visitor_email' value=''>
            <br>
			<label for='optin_visitor_first_name'>First Name</label>
            <input type='text' class='form-control capture-field long' name='optin_visitor_first_name' value=''>
            <br>
            <label for='optin_visitor_last_name'>Last Name</label>
            <input type='text' class='form-control capture-field long' name='optin_visitor_last_name' value=''>
            <br>
            <table><tr><td valign='top'>
			<input type='checkbox' name='optin_visitor_optin'>
			</td><td><div style='padding: 0px 0px 10px 10px;'>
            Please check this box to confirm that you are opting-in to receive communications from Bubble Cloud/ Bubble Social Media Marketing and the data sharing outlined in our privacy policy.
            </div></td></tr></table>
            <input type='button' class='btn btn-primary' value='Submit' id='submit_visitor_optin'> 
			<a class='btn btn-default' href='javascript:void(0);' onClick='optin_dialog_close();'>Cancel</a>
            </form>
		</div>
    </div>
    
    <div id="visitor_confirm_identity_dialog" style="display:none">
		<a href='javascript:void(0);' onClick='confirm_identity_dialog_close();' id="visitor_modal_close"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
        
        <div id="visitor_confirm_identity_modal_value_prop"><h1 style="margin-top: 0px;">
			Please confirm your email address!</h1><br>We are going to send a confirmation email to your email address to let you receive timely technology updates and the latest information from the solution providers who can help you realize your goals.<b id="confirm_identity_visitor_email"></b>  
		</div>

    	<div id="visitor_confirm_identity_error" class="alert alert-danger" role="alert" style="display:none"></div>
        <div id="visitor_confirm_identity_data">
        <form>
            <input type='hidden' name='action' value='confirm_identity'>
            <input type=hidden name='account_id' value='13818'>
            <input type=hidden name='username' value='rbishop007'>
            <input type=hidden name='go_to' value=''>
            <input type=hidden name='confirmation_go_to' value='http://contentmx.com/b/page/page.php?u=rbishop007&amp;i=3956871'>
            <input type=hidden name='confirm_identity_visitor_email' value=''>
            <br>
            <input type='button' class='btn btn-primary' value='Submit' id='submit_visitor_confirm_identity'> 
			<a class='btn btn-default' href='javascript:void(0);' onClick='confirm_identity_dialog_close();'>Cancel</a>
        </form>
        </div>
    </div>

    <div id="visitor_information_action_dialog" style="display:none">
		<a href='javascript:void(0);' onClick='information_action_dialog_close();' id="visitor_modal_close"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
        <div id="visitor_information_action_modal_value_prop">
		</div>
        <form>
            <input type='hidden' name='go_to' value=''>
            <input type='button' class='btn btn-primary' onClick='information_action_dialog_close();' value='Done'>
        </form>
    </div>
    
	<div id="visitor_modal_underlay" style="display:none;"></div>

    </div></div>
		<header>
						<script>
				document.addEventListener("DOMContentLoaded", () => {
					$('#partner-search-string').val("");
				});
			</script>
			<div id="branding" class="site-width show_search_on_home_page_directory_wrap">
					<div class="logo-col">

																					<a href="https://contentmx.com/b/page/page.php?u=bubblecloud" rel="home" title="home">
																						<span class="partner-logo" style="background-image: url('https://95a0f227d1241e679e37-1dd3aa3703950cee26a7c5779b605a2f.ssl.cf1.rackcdn.com/company%20logo%20150%20x150.png');"></span>
																						</a>
																				
													<div id="parent-account-logo">
																	<!-- <img src="https://fe5e0932bbdbee188a67-ade54de1bba9a4fe61c120942a09245b.ssl.cf1.rackcdn.com/TD-SYNNEX-logo-white.png"> -->
																							</div>
											</div>

					<div class="contact-social-company-name-wrapper">

						<div class="branding-company-name info-row">
							<div class="profile-org-name">
																																						<a href="https://contentmx.com/b/page/page.php?u=bubblecloud" rel="home" title="home">
																					Bubble Cloud/ Bubble Social Media Marketing
																					</a>
																										</div>
																						<div class="contact info-row">
									<div class="others-col">
																	<div class="social-connect contact-items">
																						<a class="facebook social-connect-item fa-brands fa-facebook" title="View on Facebook" href="https://www.facebook.com/bubblesocialmediamarketing/" target="_blank"></a>
																																	<a class="twitter social-connect-item fa-brands fa-twitter" title="View on Twitter (X)" href="https://twitter.com/BubbleSocialMed" target="_blank"></a>
																																												<a class="linkedin social-connect-item fa-brands fa-linkedin" title="View on LinkedIn" href="https://www.linkedin.com/company/bubble-social-media-marketing" target="_blank"></a>
																																													<a class="social-connect-item glyphicon glyphicon-globe" title="View Website" href="https://www.bubblesocialmediamarketing.com" target="_blank"></a>
																					<span title="Mark this company as a favorite" class="glyphicon cmx-bookmark social-connect-item glyphicon-heart-empty" bm="" ot="2" oid="13818" aria-hidden="true"></span>
										</div>
																			</div>
								</div>
													</div>

						
												<div class="content-col home_directory_search_col">
							<div id="partner_acct_directory_search">
							
<style>
.partner-score-box {
    flex-grow: 1;
    display: flex;
    flex-direction: column-reverse;
}
.score-box-row {
    width: 42px;
    height: 12px;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
}
.score-box-empty {
    width: 8px;
    height: 8px;
    border: 1px black solid;
    background: white;
}
.score-box-halffull {
    width: 8px;
    height: 8px;
    border: 1px black solid;
    background: linear-gradient(to left, white 50%, green 50%);
}
.score-box-full {
    width: 8px;
    height: 8px;
    border: 1px black solid;
    background: green;
}
</style>
<script>

    function directory_create_search_menu() {
            var output = "";
            output += "<li class=\"dropdown pull-right\">";
            output += "<a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" area-haspopup=\"true\" aria-expanded=\"false\">Your Content&nbsp;<span class=\"caret\"></span></a>";
            output += "<ul class=\"dropdown-menu\">";
        
            output += "<li><a href=\"#\" id=\"search_history\">Search History</a></li>";
            output += "<li><a href=\"#\" id=\"visitor-bookmarks\">Favorites</a></li>";
            output += "</ul>";
            output += "</li>";
            $(".menu_bar_items").html(output);
        }
        directory_create_search_menu();
        
        $(document).on("click", "#chat_history", function(e){
            e.preventDefault();
            directory_create_historical_chat_popup();
        });
        function directory_create_historical_chat_popup() {
            var formData = new FormData();
            formData.append("command", "get_conversations");
            formData.append("mid", window.known_member_id);
            formData.append("pa_id", "13818");
            $.ajax({
                "url": "https://contentmx.com/b/ai_assistant_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                    if (response.error == "") {
                        if(response.status == 1){
                        //jQuery(".ui-widget-overlay").on("click", function() {jQuery("#dialog").dialog("close");});
                            window.chat_history_dialog = $(document.createElement("div")); 
                            window.chat_history_dialog.dialog({autoOpen: false, modal: true, bgiframe: true, width:800, close: function(event, ui){$(this).dialog('destroy'); window.chat_history_dialog = '';}});
                            window.chat_history_dialog.dialog("option", "title", "Chat History");
                            window.chat_history_dialog.dialog("open");
                            if (response.conversation.length > 0) {
                                var output = "";
                                output += "<div class=\"conversation_nav_wrapper\">";
                                if (response.conversation.length > 0) {
                                    output += "<div class=\"conversation_table_filter\">";
                                    output += "<span>Conversation Filter: ";
                                    output += "<input type=\"text\" class=\"form-control\" id=\"conversation_table_filter\" name=\"conversation_filter\" value=\"\" size=\"40\" maxlength=\"100\">";
                                    output += "</span>";
                                    output += "</div>";
                                }
    
                                output += "<div class=\"conversation_table_wrapper\">";
    
                                output += "<div class=\"conversation_table\">";
                                output += "<div class=\"conversation_row conversation_header\">";
                                output += "<div class=\"conversation_col\"><strong>Chat</strong></div>";
                                output += "<div class=\"conversation_col\"><strong>Description</strong></div>";
                                output += "<div class=\"conversation_col\">&nbsp;</div>";
                                output += "</div>";
                                var bookmarked_class = "";
                                var glyphicon = "";
                                response.conversation.forEach(function(item, index) {
                                    output += "<div class=\"conversation_row conversation_data_row\" data-cid=\""+item.conversation_id+"\">";
                                    output += "<div class=\"conversation_col\">";
                                    output += "<a href=\"";
                                    output += item.conversation_url + "&cc=" + item.conversation_id;
                                    output += "\">"+item.date_enter+"</a>";
                                    output += "</div>";
                                    output += "<div class=\"conversation_col\">";
                                    output += "<div id=\"conversation_description_display_"+item.conversation_id+"\">"+item.conversation_description+"</div>";
                                    output += "<div id=\"conversation_description_edit_block_"+item.conversation_id+"\" style=\"display:none;\">";
                                    output += "<div class=\"form-control\" id=\"conversation_description_edit_"+item.conversation_id+"\" contenteditable=\"true\">"+item.conversation_description+"</div>"; 
                                    output += "<div class=\"coversation_description_edit_buttons\">";
                                    output += "<button type=\"button\" class=\"btn btn-primary\" id=\"conversation_description_save\">Save</button>";
                                    output += "<button type=\"button\" class=\"btn btn-secondary\" id=\"conversation_description_cancel\">Cancel</button>";
                                    output += "</div>";
                                    output += "</div>";
                                    output += "</div>";
                                    output += "<div class=\"conversation_col\">";
                                    output += "<span class=\"conversation_button text-info glyphicon glyphicon-edit\" id=\"conversation-edit\"></span>";
                                    output += "<span class=\"conversation_button text-danger glyphicon glyphicon-trash\" id=\"conversation-delete\"></span>";
                                    if(item.bookmark_id != "" && item.bookmark_id != null){
                                        bookmarked_class = " bookmarked";
                                        glyphicon = "glyphicon-heart";
                                    }else{
                                        bookmarked_class = "";
                                        item.bookmark_id = "";
                                        glyphicon = "glyphicon-heart-empty";
                                    }
                                    output += "<span class=\"glyphicon "+glyphicon+" cmx-bookmark"+bookmarked_class+"\" bm=\""+item.bookmark_id+"\" ot=\"4\" oid=\""+item.conversation_id+"\"></span>";
                                    output += "</div>";
                                    output += "</div>";
                                });
                                output += "</div>";
                                output += "</div>";
    
                                output += "</div>";
    
                                window.chat_history_dialog.html(output);
                            } else {
                                output = "<div class=\"conversation_nav_wrapper\">";
                                output += "You do not have any conversations.";
                                output += "</div>";
                                window.chat_history_dialog.html(output);
                            }
    
                        }else{
                            //prompt login
                            var title_html = "You must login to use this feature.";
                            if(response.notice != ""){
                                title_html = response.notice;
                            }
                            displayVisitorSignInDialog(title_html,"");
                        }
    
                    } else {
                        console.log("Get conversations failed: " + response.error);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Get conversations failed: " + textStatus);
                }
            });
        }
    
        $(document).on("click", "#search_history", function(e){
            e.preventDefault();
            directory_create_historical_search_popup();
        });
        function directory_create_historical_search_popup() {
            var formData = new FormData();
            formData.append("command", "get_searches");
            formData.append("pa_id", "13818");
            $.ajax({
                "url": "https://contentmx.com/b/partner_directory_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                        if(response.status == 1){
                            window.search_history_dialog = $(document.createElement("div")); 
                            window.search_history_dialog.dialog({autoOpen: false, modal: true, bgiframe: true, width:800, close: function(event, ui){$(this).dialog('destroy'); window.search_history_dialog = '';}});
                            window.search_history_dialog.dialog("option", "title", "Search History");
                            window.search_history_dialog.dialog("open");
                            if (response.search.length > 0) {
                                var output = "";
                                output += "<div class=\"search_nav_wrapper\">";
                                if (response.search.length > 0) {
                                    output += "<div class=\"search_table_filter\">";
                                    output += "<span>Search Filter: ";
                                    output += "<input type=\"text\" class=\"form-control\" id=\"search_table_filter\" name=\"search_filter\" value=\"\" size=\"40\" maxlength=\"100\">";
                                    output += "</span>";
                                    output += "</div>";
                                }
    
                                output += "<div class=\"search_table_wrapper\">";
    
                                output += "<div class=\"search_table\">";
                                output += "<div class=\"search_row search_header\">";
                                output += "<div class=\"search_col\"><strong>Search</strong></div>";
                                output += "<div class=\"search_col\"><strong>Search String</strong></div>";
                                output += "<div class=\"search_col\"><strong>Description</strong></div>";
                                output += "<div class=\"search_col\">&nbsp;</div>";
                                output += "</div>";
                                var bookmarked_class = "";
                                var glyphicon = "";
                                response.search.forEach(function(item, index) {
                                    output += "<div class=\"search_row search_data_row\" data-ssid=\""+item.search_session_id+"\">";
                                    output += "<div class=\"search_col\">";
                                    output += "<a href=\"";
                                    output += item.search_url + "&ss=" + item.search_session_id;
                                    output += "\">"+item.date_enter+"</a>";
                                    output += "</div>";
                                    output += "<div class=\"search_col\">";
                                    output += item.search;
                                    output += "</div>";
                                    output += "<div class=\"search_col\">";
                                    output += "<div id=\"search_description_display_"+item.search_session_id+"\">"+item.search_description+"</div>";
                                    output += "<div id=\"search_description_edit_block_"+item.search_session_id+"\" style=\"display:none;\">";
                                    output += "<div class=\"form-control\" id=\"search_description_edit_"+item.search_session_id+"\" contenteditable=\"true\">"+item.search_description+"</div>"; 
                                    output += "<div class=\"search_description_edit_buttons\">";
                                    output += "<button type=\"button\" class=\"btn btn-primary\" id=\"search_description_save\">Save</button>";
                                    output += "<button type=\"button\" class=\"btn btn-secondary\" id=\"search_description_cancel\">Cancel</button>";
                                    output += "</div>";
                                    output += "</div>";
                                    output += "</div>";
                                    output += "<div class=\"search_col\">";
                                    output += "<span class=\"search_button text-info glyphicon glyphicon-edit\" id=\"search-edit\"></span>";
                                    output += "<span class=\"search_button text-danger glyphicon glyphicon-trash\" id=\"search-delete\"></span>";
                                    if(item.bookmark_id != "" && item.bookmark_id != null){
                                        bookmarked_class = " bookmarked";
                                        glyphicon = "glyphicon-heart";
                                    }else{
                                        bookmarked_class = "";
                                        item.bookmark_id = "";
                                        glyphicon = "glyphicon-heart-empty";
                                    }
                                    output += "<span class=\"glyphicon "+glyphicon+" cmx-bookmark"+bookmarked_class+"\" bm=\""+item.bookmark_id+"\" ot=\"3\" oid=\""+item.search_session_id+"\"></span>";
                                    output += "</div>";
                                    output += "</div>";
                                });
                                output += "</div>";
                                output += "</div>";
    
                                output += "</div>";
    
                                window.search_history_dialog.html(output);
                            } else {
                                output = "<div class=\"search_nav_wrapper\">";
                                output += "You do not have any searches.";
                                output += "</div>";
                                window.search_history_dialog.html(output);
                            }
                        }else{
                            //prompt login
                            var title_html = "You must login to use this feature.";
                            if(response.notice != ""){
                                title_html = response.notice;
                            }
                            displayVisitorSignInDialog(title_html,"");
                        }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Get searches failed: " + textStatus);
                }
            });
        }
    
        $(document).on("keyup", "#conversation_table_filter", function(event) {
            // hide/show all elements that match
            var needle = $("#conversation_table_filter").val().toLowerCase();
            $(".conversation_data_row").each(function() {
                var haystack = $(this).text().toLowerCase();
                if (haystack.indexOf(needle) === -1)
                    $(this).hide();
                else
                    $(this).show();
            });
        });
        $(document).on("click", "#conversation-edit", function(event) {
            var row = $(this).closest(".conversation_row")
            var cid = row.data("cid");
            $("#conversation_description_display_"+cid).hide();
            $("#conversation_description_edit_block_"+cid).show();
        });
        $(document).on("click", "#conversation_description_save", function(event) {
            var row = $(this).closest(".conversation_row")
            var cid = row.data("cid");
            var description = $("#conversation_description_edit_"+cid).html();
            var formData = new FormData();
            formData.append("command", "update_conversation");
            formData.append("mid", window.known_member_id);
            formData.append("cid", cid);
            formData.append("description", description);
            $.ajax({
                "url": "https://contentmx.com/b/ai_assistant_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                    if (response.error == "") {
                        $("#conversation_description_edit_block_"+cid).hide();
                        $("#conversation_description_display_"+cid).html(description);
                        $("#conversation_description_display_"+cid).show();
                    } else {
                        console.log("Conversation delete failed: " + response.error);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Conversation delete failed: " + textStatus);
                }
            });
        });
        $(document).on("click", "#conversation_description_cancel", function(event){
            var row = $(this).closest(".conversation_row")
            var cid = row.data("cid");
            $("#conversation_description_edit_block_"+cid).hide();
            $("#conversation_description_edit_"+cid).html($("#conversation_description_display_"+cid).html());
            $("#conversation_description_display_"+cid).show();
        });
        $(document).on("click", "#conversation-delete", function(event){
            var row = $(this).closest(".conversation_row")
            var cid = row.data("cid");
            var formData = new FormData();
            formData.append("command", "delete_conversation");
            formData.append("mid", window.known_member_id);
            formData.append("cid", cid);
            $.ajax({
                "url": "https://contentmx.com/b/ai_assistant_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                    if (response.error == "") {
                        row.hide();
                    } else {
                        console.log("Conversation delete failed: " + response.error);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Conversation delete failed: " + textStatus);
                }
            });
        });
    
        $(document).on("keyup", "#search_table_filter", function(event) {
            // hide/show all elements that match
            var needle = $("#search_table_filter").val().toLowerCase();
            $(".search_data_row").each(function() {
                var haystack = $(this).text().toLowerCase();
                if (haystack.indexOf(needle) === -1)
                    $(this).hide();
                else
                    $(this).show();
            });
        });
        $(document).on("click", "#search-edit", function(event) {
            var row = $(this).closest(".search_row")
            var ssid = row.data("ssid");
            $("#search_description_display_"+ssid).hide();
            $("#search_description_edit_block_"+ssid).show();
        });
    
        $(document).on("click", "#search_description_save", function(event) {
            var row = $(this).closest(".search_row")
            var ssid = row.data("ssid");
            var description = $("#search_description_edit_"+ssid).html();
            var formData = new FormData();
            formData.append("command", "update_search");
            formData.append("ssid", ssid);
            formData.append("description", description);
            $.ajax({
                "url": "https://contentmx.com/b/partner_directory_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                    if (response.status == 0) {
                        $("#search_description_edit_block_"+ssid).hide();
                        $("#search_description_display_"+ssid).html(description);
                        $("#search_description_display_"+ssid).show();
                    } else {
                        console.log("Search delete failed: " + response.status);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Search delete failed: " + textStatus);
                }
            });
        });
        $(document).on("click", "#seach_description_cancel", function(event){
            var row = $(this).closest(".search_row")
            var ssid = row.data("ssid");
            $("#search_description_edit_block_"+ssid).hide();
            $("#search_description_edit_"+ssid).html($("#search_description_display_"+ssid).html());
            $("#search_description_display_"+ssid).show();
        });
        $(document).on("click", "#search-delete", function(event){
            var row = $(this).closest(".search_row")
            var ssid = row.data("ssid");
            var formData = new FormData();
            formData.append("command", "delete_search");
            formData.append("ssid", ssid);
            $.ajax({
                "url": "https://contentmx.com/b/partner_directory_commands.php",
                "type": "post",
                "data": formData,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (response) {
                    if (response.status == 0) {
                        row.hide();
                    } else {
                        console.log("Search delete failed: " + response.status);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Search delete failed: " + textStatus);
                }
            });
        });
        
function img_error_replace(image) {
    image.onerror = "";
    image.src = "https://fe5e0932bbdbee188a67-ade54de1bba9a4fe61c120942a09245b.ssl.cf1.rackcdn.com/generic-image-unsplash_thumbnail.jpg";
    return true;
}
function removeParam(key, sourceURL) {
    var rtn = sourceURL.split("?")[0],
        param,
        params_arr = [],
        queryString = (sourceURL.indexOf("?") !== -1) ? sourceURL.split("?")[1] : "";
    if (queryString !== "") {
        params_arr = queryString.split("&");
        for (var i = params_arr.length - 1; i >= 0; i -= 1) {
            param = params_arr[i].split("=")[0];
            if (param === key) {
                params_arr.splice(i, 1);
            }
        }
        if (params_arr.length) rtn = rtn + "?" + params_arr.join("&");
    }
    return rtn;
}
function get_youtube_id(url) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    var match = url.match(regExp);
    return (match && match[2] != "") ? match[2] : false;
}
function get_vimeo_id(url){
    var id = "";
    var regExp = /^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;
    var match = url.match(regExp);
    if (match){
        return match[5];
    }else{
        return false;
    }
}
function score_html(val, max) {
    var score = (max == 0) ? 0 : Math.round(val * 100 / max);
    var html = "<div class=\"score-box-row\">";
    var full = "<div class=\"score-box-full\"/>";
    var halffull = "<div class=\"score-box-halffull\"/>";
    var empty = "<div class=\"score-box-empty\"/>";
    
    if (score > 25)
        html += full;
    else if (score == 0)
        html += empty;
    else
        html += halffull;
    
    if (score > 50)
        html += full;
    else if (score > 37)
        html += halffull;
    else
        html += empty;
    
    if (score > 75)
        html += full;
    else if (score > 62)
        html += halffull;
    else
        html += empty;
    
    if (score == 100)
        html += full;
    else if (score > 87)
        html += halffull;
    else
        html += empty;
    
    html += "</div>";
    return html;
}
function get_nav_selected_values(){

    //get list of active tag ID
    var return_values = [];
    return_values.tag_ids_channel = [];
    return_values.tag_ids_channel_url = [];
    return_values.tag_ids_account = [];
    return_values.tag_ids_account_url = [];
    return_values.form_ids = [];
    return_values.form_ids_url = [];
    return_values.filter_tag_ids = [];
    return_values.featured_flag = "";

    $("#directory_nav_wrapper li.active, #home_directory_search_nav li.active").each(function () {
        var current_this = $(this);
        if($(current_this).hasClass("channel_tag")){
            if ($(this).attr("ptid") != 0) {
                return_values.tag_ids_channel.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
                return_values.tag_ids_channel_url.push($(this).attr("tid"));
            }
            //check to see if this has selected child. if not add all child tags
            if ($(current_this).find(".active").length == 0 && $(current_this).children("ul").find("li").length != 0){
                $(current_this).children("ul").find("li").each(function () {
                    return_values.tag_ids_channel.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
                    return_values.tag_ids_channel_url.push($(this).attr("tid"));
                });
            }
        }
        if($(current_this).hasClass("account_tag")){
            if ($(this).attr("ptid") != 0) {
                return_values.tag_ids_account.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
                return_values.tag_ids_account_url.push($(this).attr("tid"));
            }
            //check to see if this has selected child. if not add all child tags
            if ($(current_this).find(".active").length == 0 && $(current_this).children("ul").find("li").length != 0){
                $(current_this).children("ul").find("li").each(function () {
                    return_values.tag_ids_account.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
                    return_values.tag_ids_account_url.push($(this).attr("tid"));
                });
            }
        }
        if ($(current_this).hasClass("form_tag_parent")) {
            //check to see if this has selected child. if not add all child tags
            if ($(current_this).find(".active").length == 0 && $(current_this).children("ul").find("li").length != 0){
                $(current_this).children("ul").find("li").each(function () {
                    return_values.form_ids.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
                    return_values.form_ids_url.push($(this).attr("tid"));
                });
            }
        }
        if ($(current_this).hasClass("form_tag")) {
            return_values.form_ids.push($(this).attr("ptid")+"|"+$(this).attr("tid"));
            return_values.form_ids_url.push($(this).attr("tid"));
        }
    });
    
    //add filter tags if any are selected
    $(".dir_filter_outer_wrapper > .dir_filter_parent.dir_filter_item").each(function () {
        var current_this = $(this);
        if($(current_this).attr("tid") != "ALL" && $(current_this).attr("tid") != "not_featured_only" && $(current_this).attr("tid") != "featured_only"){
            return_values.filter_tag_ids.push( $(current_this).attr("tid") );
        }else{
            if($(current_this).attr("tid") == "not_featured_only" || $(current_this).attr("tid") == "featured_only"){
                return_values.featured_flag = $(current_this).attr("tid");
            }
        }
    });

    return return_values;
}

function url_param_redirect(){
    var current_url = window.location.href;

    var url_obj = new URL(current_url);
    var dir = url_obj.searchParams.get("dir");
    var retd = url_obj.searchParams.get("retd");
    var i = url_obj.searchParams.get("i");
    var u = url_obj.searchParams.get("u");
    var page_params = [];
    if(u != null){
        page_params.push("u="+u);
    }
    if(i != null){
        page_params.push("i="+i);
    }
    if(dir == 1){
        page_params.push("dir="+dir);
    }
    if(retd == 1){
        page_params.push("retd="+retd);
    }
    if(window.dashboard_embed == 1){
        page_params.push("dash_emb=1");
    }
    page_params = page_params.join("&");
    var filter_params = [];
    var filter_nav_values = get_nav_selected_values();

    var tag_ids_channel = filter_nav_values.tag_ids_channel_url;
    if(tag_ids_channel.length > 0){
        tag_ids_channel = tag_ids_channel.join(",");
        filter_params.push("ct="+tag_ids_channel);
    }
    var tag_ids_account = filter_nav_values.tag_ids_account_url;
    if(tag_ids_account.length > 0){
        tag_ids_account = tag_ids_account.join(",");
        filter_params.push("at="+tag_ids_account);
    }
    var form_ids = filter_nav_values.form_ids_url;
    if(form_ids.length > 0){
        form_ids = form_ids.join(",");
        filter_params.push("ft="+form_ids);
    }
    
    var filter_tag_ids = filter_nav_values.filter_tag_ids;
    if(filter_tag_ids.length > 0){
        filter_tag_ids = filter_tag_ids.join(",");
        filter_params.push("flt="+filter_tag_ids);
    }
    
    var featured_flag = filter_nav_values.featured_flag;
    if(featured_flag != ""){
        filter_params.push("fe="+featured_flag);
    }
    var search_string = $("#partner-search-string").val();
    if(search_string != ""){
        filter_params.push("q="+encodeURIComponent(search_string));
    }
    if(filter_params.length > 0){
        filter_params = filter_params.join("&");
    }else{
        filter_params = "";
    }
    if(filter_params != ""){
        window.location.href = location.protocol+"//"+location.host+location.pathname+"?"+page_params+"&"+filter_params;
    }else{
        window.location.href = location.protocol+"//"+location.host+location.pathname+"?"+page_params;
    }
}

function directory_render_whimsy(type = "start", full_items_count = 0){
    $("#directory_whimsy").hide();

    var additional_external_results = "";
    if((window.partner_directory_sort_filtering == 2 || window.partner_directory_sort_filtering == 3)){
        if(window.partner_directory_sort_filtering == 2){
            if(window.local_items_full_count < full_items_count){
                additional_external_results = "<p>We have found "+full_items_count+" matching items on <a style=\"color:#3c77b9; text-decoration:underline;\" id=\"home_directory_parent_link\" href=\"https://partneron.com\">PartnerOn</a></p>";
            }
        }
    }

    if(type == "start"){
        if($("#directory_whimsy").length == 0){
            $("#directory_content_wrapper").prepend("<div id=\"directory_whimsy\">"+window.start_whimsy[Math.floor(Math.random()*window.start_whimsy.length)]+"</div>");
        }else{
            $("#directory_whimsy").html(window.start_whimsy[Math.floor(Math.random()*window.start_whimsy.length)]).show();
        }
    }else if(type == "no_tokens_encouragement"){
        //no results
        $("#directory_whimsy").html(window.no_results_no_keywords_whimsy[Math.floor(Math.random()*window.no_results_no_keywords_whimsy.length)]+additional_external_results).show();
    }else if(type == "tokens_encouragement"){
        //no results
        $("#directory_whimsy").html(window.no_results_has_keywords_whimsy[Math.floor(Math.random()*window.no_results_no_keywords_whimsy.length)]+additional_external_results).show();
    }
}

function clear_initial_screen(){
    if($("#directory_content_wrapper .directory_chat_wrapper").length > 0){
        $("#directory_content_wrapper .directory_chat_wrapper").remove();
        $("#directory_sidebar_wrapper .directory_chat_wrapper .answer-wrapper").show();
        $("#directory_sidebar_wrapper .directory_chat_wrapper .ai_sample_questions").remove();
        $("#directory_sidebar_wrapper .directory_chat_wrapper #question-prompt").remove();
        $("#directory_filters").show();
        $("#directory_ai_search").show();
        $(".directory_feature_listing_wrapper").show();
    }
}

function hide_show_clear_filters(){
    $show_clear_filters = 0;
    $filters_are_all_hidden = 1;
    $(".dir_filter_outer_wrapper > .dir_filter_parent.dir_filter_item").each(function () {
        var current_this = $(this);
        if($(current_this).closest(".dir_filter_outer_wrapper").css("display") != "none"){
            $filters_are_all_hidden = 0;
        }
        if($(current_this).attr("tid") != "ALL" && $(current_this).closest(".dir_filter_outer_wrapper").css("display") != "none"){
            $show_clear_filters = 1;
        }
    });
    if($filters_are_all_hidden != 1){
        $("#directory_nav_wrapper .channel_tag, #home_directory_search_nav .channel_tag").each(function () {
            var current_this = $(this);
            if($(current_this).hasClass("active")){
                $show_clear_filters = 1;
            }
        });
    }

    if($show_clear_filters == 0){
        $("#clear_directory_filters_wrapper").remove();
    }else{
        if($("#clear_directory_filters_wrapper").length == 0){
            $("#directory_filters > .dir_filter_wrapper").append("<div id=\"clear_directory_filters_wrapper\" style=\"padding:0 0 0 20px; position: relative;\"><button style=\"position:absolute; top: 50%; -webkit-transform: translateY(-50%); -ms-transform: translateY(-50%); transform: translateY(-50%);\" id=\"clear_directory_filters\" class=\"btn btn-secondary\">Clear Filters</button></div>");
        }
    }
}

function partner_command(command)
{
    clear_initial_screen();
    window.cmx_prevent_load_on_scroll = 0;
    if (command == "get_partner_directory_entries") {
        $("#directory_notices").html("").hide();
    }
    //get list of active tag ID
    var tag_ids_channel = [];
    var tag_ids_account = [];
    var form_ids = [];
    //add filter tags if any are selected
    var filter_tag_ids = [];
    var featured_flag = "";
    var nav_values = get_nav_selected_values();

    tag_ids_channel = nav_values.tag_ids_channel;
    tag_ids_account = nav_values.tag_ids_account;
    form_ids = nav_values.form_ids;
    filter_tag_ids = nav_values.filter_tag_ids;
    featured_flag = nav_values.featured_flag;

    // something changed; get an updated display
    var search_string = $("#partner-search-string").val();
    window.last_search_string = search_string;
    var is_dash_emb = 0;
    var page = window.page;
    var naids = [];
    var niids = [];
    if(command == "get_partner_content_entries"){
        page = window.items_page;
        if (page > 1 && 'niids' in window) {
            niids = window.niids
        }   
    }
    if(command == "get_partner_content_accounts"){
        page = window.accounts_page;
        if (page > 1 && 'naids' in window) {
            naids = window.naids
        }    
    }
    if(command == "get_partner_directory_entries_mode_items"){
        page = window.accounts_page;
        command = "get_partner_directory_entries";
    }

    var surl = removeParam("ss", removeParam("cc", window.location.href));
    var data = { 
        "command": command, 
        "pa_id": 13818,
        "tag_ids_channel": tag_ids_channel, 
        "tag_ids_account": tag_ids_account, 
        "filter_tags": filter_tag_ids,
        "featured_flag": featured_flag,
        "search": search_string, 
        "form_ids": form_ids,
        "partner_id": "0",
        "page": page,
        "dash_emb": is_dash_emb,
        "mid": window.known_member_id,
        "naids": naids,
        "niids": niids,
        "ssid": window.search_session_id,
        "sssid": window.sub_search_session_id,
        "surl": surl
    };
    if (command == "get_partner_directory_entries") {
        var params_set = 0;
        if((tag_ids_channel.length > 0 || tag_ids_account.length > 0 || filter_tag_ids.length > 0 || search_string != "" || form_ids.length > 0) && featured_flag == ""){
            params_set = 1;
        }

        $.ajax({
            type: "POST",
            url: "https://contentmx.com/b/partner_directory_commands.php",
            data: data,
            dataType: "json",
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function(data) {
                // console.log(data);
                if ("ssid" in data) {
                    window.search_session_id = data.ssid;
                    window.sub_session_id = 0;
                }
                if ("sssid" in data) {
                    window.sub_search_session_id = data.sssid;
                }

                if("full_accounts_count" in data){
                //console.log(data.full_accounts_count, window.full_count);
                    if(data.full_accounts_count != window.full_count){
                        //console.log("reset to page 1");
                        window.page = 1;
                    }
                    window.full_count = data.full_accounts_count;
                }

                var listing_type = "ALL";
                if($(".dir_filter_parent.dir_filter_item.featured_items").length != 0){
                    listing_type = $(".dir_filter_parent.dir_filter_item.featured_items").attr("tid");
                }

                if(listing_type == "ALL"){

                    //==============================
                    //if we are showing everything
                    //==============================
                    //load or hide feature listings
                    if("feature_entries" in data){
                        if(data.feature_entries != "" && ((data.no_feature_results == true && data.no_results == true) || (data.no_feature_results == false && data.no_results == false) || (data.no_feature_results == false && data.no_results == true))){
                            $(".directory_feature_listing_wrapper").show();
                            $(".directory_feature_listing_wrapper").html(data.feature_entries);
                            $(".dir_filter_outer_wrapper .featured_items").closest(".dir_filter_outer_wrapper ").show();
                        }else{
                            $(".directory_feature_listing_wrapper").hide();
                            $(".directory_feature_listing_wrapper").html(data.feature_entries);
                            $(".dir_filter_outer_wrapper .featured_items").closest(".dir_filter_outer_wrapper ").hide();
                        }
                    }else{
                        $(".directory_feature_listing_wrapper").hide();
                    }

                    if(page == 1){
                        if($(".partner_block_wrapper").length){
                            $(".partner_block_wrapper").html(data.accounts);
                        }else if($("#account_block_result_output").length > 0){
                            $("#account_block_result_output").html(data.accounts);
                        }
                    }else{
                        if($(".partner_block_wrapper").length){
                            $(".partner_block_wrapper").append(data.accounts);
                        }else if($("#account_block_result_output").length > 0){
                            directory_accounts_listings_render(data, true);
                        }
                    }

                    if (data.no_results) {
                        $("#directory_notices").prepend("<div class=\"alert alert-info\" style=\"margin-bottom:0;\" role=\"alert\">There are no companies that match your criteria. Please try changing or removing your selection.</div>").show();
                    }else{
                        //do we have parameters or is this an all case?
                        if(params_set == 1 && "full_accounts_count" in data){
                            var notice_text = "companies found";
                            if(data.full_accounts_count == 1){
                                notice_text = "company found";
                            }
                            $("#directory_notices").prepend("<div class=\"alert alert-info\" style=\"margin-bottom:0;\" role=\"alert\">"+data.full_accounts_count+" "+notice_text+"</div>").show();
                        }
                    }
                    window.calling_load = 0;
                    $("#load_more .load_more_loading").hide();

                }else if(listing_type == "featured_only"){ 
                    //==============================
                    //if we are showing only featured
                    //==============================
                    //load or hide feature listings
                    if("feature_entries" in data){
                        if(data.feature_entries != ""){
                            $(".directory_feature_listing_wrapper").show();
                            $(".directory_feature_listing_wrapper").html(data.feature_entries);
                        }else{
                            $(".directory_feature_listing_wrapper").hide();
                            $(".directory_feature_listing_wrapper").html(data.feature_entries)
                        }
                    }else{
                        $(".directory_feature_listing_wrapper").hide();
                    }

                    if(window.page == 1){
                        $(".partner_block_wrapper").html(data.accounts);
                    }else{
                        $(".partner_block_wrapper").append(data.accounts);
                    }

                    if (data.no_feature_results) {
                        $("#directory_notices").prepend("<div class=\"alert alert-info\" style=\"margin-bottom:0;\" role=\"alert\">There are no companies that match your criteria. Please try changing or removing your selection.</div>").show();
                    }

                    window.calling_load = 0;
                    $("#load_more .load_more_loading").hide();
                    if (typeof set_to_init === "function"){
                        //this is an items mode function
                        set_to_init();
                    }
                    if(typeof set_accounts_to_init === "function"){
                        set_accounts_to_init();
                    }

                }else if(listing_type == "not_featured_only"){

                    //==============================
                    //if we are showing only standard
                    //==============================
                    if("feature_entries" in data){
                        if(data.feature_entries != ""){
                            $(".directory_feature_listing_wrapper").hide();
                            $(".directory_feature_listing_wrapper").html(data.feature_entries);
                        }
                    }else{
                        $(".directory_feature_listing_wrapper").hide();
                    }

                    if(window.page == 1){
                        $(".partner_block_wrapper").html(data.accounts);
                    }else{
                        $(".partner_block_wrapper").append(data.accounts);
                    }

                    if (data.no_results) {
                        $("#directory_notices").prepend("<div class=\"alert alert-info\" style=\"margin-bottom:0;\" role=\"alert\">There are no companies that match your criteria. Please try changing or removing your selection.</div>").show();
                    }else{
                        //do we have parameters or is this an all case?
                        if(params_set == 1 && "full_accounts_count" in data){
                            var notice_text = "companies found";
                            if(data.full_accounts_count == 1){
                                notice_text = "company found";
                            }
                            $("#directory_notices").prepend("<div class=\"alert alert-info\" style=\"margin-bottom:0;\" role=\"alert\">"+data.full_accounts_count+" "+notice_text+"</div>").show();
                        }
                    }
                    window.calling_load = 0;
                    $("#load_more .load_more_loading").hide();

                }
                window.getting_partners = false;
                if (window.pending_getting_partner_request) {
                    window.pending_getting_partner_request = false;
                    update_partners(false);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                window.getting_partners = false;
                if (window.pending_getting_partner_request) {
                    window.pending_getting_partner_request = false;
                    update_partners(false);
                }
            }
        });
    } else if (command == "get_partner_content_entries" || command == "get_partner_directory_and_content_entries"){
        $.ajax({
            type: "POST",
            url: "https://contentmx.com/b/partner_directory_commands.php",
            data: data,
            dataType: "json",
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function(data) {
                if ("ssid" in data) {
                    window.search_session_id = data.ssid;
                    window.sub_session_id = 0;
                }
                directory_items_listings_render(data);
                if (typeof set_to_init === "function"){
                    //this is an items mode function
                    set_to_init();
                }
                if(typeof set_accounts_to_init === "function"){
                    set_accounts_to_init();
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                window.getting_partners = false;
                if (window.pending_getting_partner_request) {
                    window.pending_getting_partner_request = false;
                    update_partners(false);
                } else {
                    if (typeof set_to_init === "function") {
                        //this is an items mode function
                        set_to_init();
                    }
                    if (typeof set_accounts_to_init === "function") {
                        set_accounts_to_init();
                    }
                }
            }
        });
    } else if (command == "get_partner_content_accounts"){
        var item_id = "";
        if($(".directory_item_block.active").length != 0){
            item_id = $(".directory_item_block.active").attr("iid");
        }
        var surl = removeParam("ss", removeParam("cc", window.location.href));
        var local_data = {
            "command": "get_partner_directory_entries", 
            "pa_id": 13818,
            "iid": item_id,
            "partner_id": "0",
            "page": page,
            "dash_emb": is_dash_emb,
            "mid": window.known_member_id,
            "get_all_if_none": false,
            "ssid": window.search_session_id,
            "sssid": window.sub_search_session_id,
            "surl": surl
        };
        if(validate_account_call_data(local_data)){
            $.ajax({
                type: "POST",
                url: "https://contentmx.com/b/partner_directory_commands.php",
                data: local_data,
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function(data) {
                    if ("ssid" in data) {
                        window.search_session_id = data.ssid;
                        window.sub_session_id = 0;
                    }
                    if ("sssid" in data) {
                        window.sub_search_session_id = data.sssid;
                    }
                    directory_accounts_listings_render(data, false);
                    if (typeof set_accounts_to_init === "function"){
                        //this is an items mode function
                        set_accounts_to_init();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus);
                    window.getting_partners = false;
                    if (window.pending_getting_partner_request) {
                        window.pending_getting_partner_request = false;
                        update_partners(false);
                    }else{
                        if (typeof set_to_init === "function"){
                            //this is an items mode function
                            set_accounts_to_init();
                        }
                    }
                }
            });
        }

    } else if (command == "export_partner_directory_entries" || command == "export_partner_directory_entries_csv" || command == "export_partner_directory_entries_json" || command == "export_partner_content_entries_csv") {
        // build a url with the parameters
        const params = Object.keys(data).map(
            key => Array.isArray(
                data[key]) 
                ? data[key].map(v => `${key}[]=${v}`).join("&") 
                : `${key}=${data[key]}`
        ).join("&");
        const url = "https://contentmx.com/b/partner_directory_commands.php?" + params;
        var a = document.createElement("a");
        a.href = url;
        document.body.append(a);
        a.click();
        a.remove();
    }
}

function partner_search_command(more = false, done_callback = "")
{
    window.cmx_prevent_load_on_scroll = 0;
    if (!more) {
        // clear the directory results
        $("#items_block_result_output").html("");
        $("#account_block_result_output").html("");
        $("#items_block_result_wrapper .notices").html("").hide();
        $("#account_block_result_wrapper .notices").html("").hide();
        $(".ai_partner_block_wrapper").hide().html("");
        $("#ai_account_notices").html("").hide();
    }
    
    if (!window.getting_items) {;
        window.getting_items = true;
        $("#items_block_result_wrapper").show();
        $("#account_block_result_wrapper").show();
        $("#items_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
        $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
        $("#account_block_result_wrapper").addClass("results_from_account"); //mark it as coming from account
    } else {
        window.pending_getting_items_request = true;
        return;
    }

    var is_dash_emb = 0
    var surl = removeParam("ss", removeParam("cc", window.location.href));
    var data = { 
        "command": "get_partner_directory_and_content_entries",
        "pa_id": 13818,
        "search": window.search_tokens, 
        "partner_id": "0",
        "page": window.page, 
        "dash_emb": is_dash_emb,
        "mid": window.known_member_id,
        "get_all_if_none": false,
        "ssid": window.search_session_id,
        "sssid": window.sub_search_session_id,
        "surl": surl
    };

    $.ajax({
        type: "POST",
        url: "https://contentmx.com/b/partner_directory_commands.php",
        data: data,
        dataType: "json",
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success: function(data) {
            // console.log(data);
            if ("ssid" in data) {
                window.search_session_id = data.ssid;
                window.sub_session_id = 0;
            }

            $("#ai_account_notices").hide();
            $(".ai_partner_block_wrapper").html("").hide();
            $("#directory_sidebar_wrapper #directory_ask_question").removeClass("disabled");
            directory_items_listings_render(data);
            if (typeof set_to_init === "function") {
                //this is an items mode function
                set_to_init();
            }

            if (typeof set_accounts_to_init === "function") {
                set_accounts_to_init();
            }

            if (done_callback != "")
                done_callback();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
            window.getting_partners = false;
            if (window.pending_getting_partner_request) {
                window.pending_getting_partner_request = false;
                update_partners(false);
            } else {
                $("#directory_sidebar_wrapper #directory_ask_question").removeClass("disabled");
                if (typeof set_to_init === "function") {
                    //this is an items mode function
                    set_to_init();
                }
                if (typeof set_accounts_to_init === "function") {
                    set_accounts_to_init();
                }
            }
        }
    });
 }
 
 window.ai_search_full_count = 0;
 window.ai_search_page = 1;
 
 function clear_directory_splash_screen(){
     if($("#cmx_directory_intro").length > 0){
         $("#cmx_directory_intro").remove();
         $("#cmx_directory_intro_underlay").remove();
     } 
 }
 function execute_directory_search(search_string){
     clear_directory_splash_screen();
     if (search_string.localeCompare(window.last_search_string) != 0) {
         $(".partner_block_wrapper").show();
         window.page = 1; //we made a change in filtering so reset page
         update_partners(false);
     }
 }

 function adjust_ai_chat_layout(){
    var wide_initial_ai_width = 1;
    if($("#items_block_result_output").length > 0){
        if($("#items_block_result_output").text() != ""){
            wide_initial_ai_width = 0;
        }
    }
    if($(".show_search_on_home_page").length != 0){
        if(wide_initial_ai_width == 1){
            $("#home_directory_search_modal").addClass("wide_initial_ai_width");
        }else{
            $("#home_directory_search_modal").removeClass("wide_initial_ai_width");
        }
    }else{
        if(wide_initial_ai_width == 1){
            $("#partner_directory_wrapper.ai_enabled").addClass("wide_initial_ai_width");
        }else{
            $("#partner_directory_wrapper.ai_enabled").removeClass("wide_initial_ai_width");
        }
    }
}

//on load event
document.addEventListener("DOMContentLoaded", () => {

    if(!$("#partner_directory_wrapper").hasClass("show_search_on_home_page")){
        $("#partner_directory_wrapper").css({"min-height":jQuery(window).height()+50});
    }
    window.last_search_string = "";
    window.getting_partners = false;
    window.pending_getting_partner_request = false;
    window.search_session_id = 0;
    window.sub_search_session_id = 0;
    window.dashboard_embed = 0;
    
    //add admin export button
    $("#directory_export").click(function(e) {
        e.stopPropagation();
        partner_command("export_partner_directory_entries");
    });
    $("#directory_export_csv").click(function(e) {
        e.stopPropagation();
        partner_command("export_partner_directory_entries_csv");
    });
    $("#directory_export_json").click(function(e) {
        e.stopPropagation();
        partner_command("export_partner_directory_entries_json");
    });
    $("#directory_export_doc_csv").click(function(e) {
        e.stopPropagation();
        partner_command("export_partner_content_entries_csv");
    });
    //add arrows to parent tags with children for nav
    $("#directory_nav_wrapper ul li, #home_directory_search_nav ul li").each(function () {
        if ($(this).children("ul").find("li").length != 0) {
            $(this).children(".tag_nav_title_wrapper").children(".open_menu").children(".open_menu_indicator").append('<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>');
        }
    });
    //add arrows to parent tags with children for filters
    $("#directory_filters .dir_filter_parent").each(function () {
        if ($(this).children(".dir_filter_wrapper").find(".dir_filter_item").length != 0) {
            $(this).children(".open_menu").children(".open_menu_indicator").append('<span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>');
        }
    });
    //add ALL options to top level selectors of filter
    //
    $("#directory_filters .dir_filter_outer_wrapper > .dir_filter_parent > .dir_filter_wrapper").each(function () {
        $(this).prepend("<div class=\"dir_filter_child dir_filter_item\" tid=\"ALL\"><span class=\"filter_tag_name\">ALL</span></div>");
    });

    //START expand those with expanded set
    $("li.expanded .open_menu_indicator .glyphicon").removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down");
    $("li.expanded ul").show();
    //END expand those with expanded set

    //open any selected nav branches
    $(".glyphicon-check.partner_directory_checked").each(function(i, obj) {
        $(this).closest(".directory_ul_nav_wrapper").show();
        var this_parents = $(this).parents(".channel_tag, .account_tag");
        var this_count = 0;
        $(this_parents).each(function(i, obj) {
            if(this_count != 0){
                $(this).children(".tag_nav_title_wrapper").find(" .dir_tag_name .open_menu_indicator .glyphicon-chevron-right").removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down");
            }
            this_count = 1;
        });
    });
    $(document).keyup(function(e) {
        if($("#partner-search-string").is(":focus")){
            if($("#partner-search-string").val() != ""){
                $("#clear_directory_search").css({"display":""});
            }else{
                $("#clear_directory_search").hide();
            }
        }
    });
    $(document).keypress(function(e) {
        if ($("#partner-search-string").is(":focus") && e.key == "Enter") {
            e.preventDefault();
            var search_string = $("#partner-search-string").val();
            if(search_string != ""){
                //$("#home_directory_search_modal").show();
                $(".show_search_on_home_page_directory_wrap .directory_ul_nav_wrapper").show();
                $(".show_search_on_home_page_directory_wrap .directory_chat_wrapper").hide();
                $("#home_directory_search_modal").removeClass("ai_enabled");
                $(".show_search_on_home_page_directory_wrap #directory_filter_search").find(".radio_circle").addClass("active");
                $(".show_search_on_home_page_directory_wrap #directory_ai_search").find(".radio_circle").removeClass("active");
                url_param_redirect();
            }
        }
    });
    $(document).on("click", "#clear_directory_home_search, .show_search_on_home_page #clear_directory_search", function(event){

            $("#home_directory_search_modal").hide();
            $(".show_search_on_home_page_directory_wrap #directory_filter_search").find(".radio_circle").removeClass("active");
            $(".show_search_on_home_page_directory_wrap #directory_ai_search").find(".radio_circle").removeClass("active");
            $(".show_search_on_home_page #partner-search-string").val("");
            url_param_redirect();
        
    });
    $("#home_directory_search_button").click(function(e) {
        e.preventDefault();
        var search_string = $("#partner-search-string").val();
        if(search_string != ""){
            $(".show_search_on_home_page_directory_wrap #directory_filter_search").find(".radio_circle").addClass("active");
            $(".show_search_on_home_page_directory_wrap #directory_ai_search").find(".radio_circle").removeClass("active");
            //$(".show_search_on_home_page_directory_wrap #home_directory_search_modal").show();
            $(".show_search_on_home_page_directory_wrap #directory_ai_thread").hide();
            $(".show_search_on_home_page_directory_wrap .directory_ul_nav_wrapper").show();
            url_param_redirect();
        }
    });
    $("body").on("click", "#header_directory_search_button", function(e) {
        e.preventDefault();
        var search_string = $("#partner-search-string").val();
        if(search_string != ""){
            url_param_redirect();
        }
    });

    $("body").on("keyup", "#cmx_directory_intro #splash_partner-search-string", function(e) {
        if ((e.key == "Enter" || e.keyCode == 13)) {
            var search_string = $(this).val();
            $("#directory_header_search_wrapper #partner-search-string").val(search_string);
            $("#directory_filter_search .radio_circle").addClass("active");
            $("#directory_ai_search .radio_circle").removeClass("active");
            url_param_redirect();
        }
    });
    $("#cmx_directory_intro #splash_search_button").click(function(e) {
        var search_string = $("#cmx_directory_intro #splash_partner-search-string").val();
        $("#directory_filter_search .radio_circle").addClass("active");
        $("#directory_ai_search .radio_circle").removeClass("active");
        $("#directory_header_search_wrapper #partner-search-string").val(search_string);
        url_param_redirect();
    });
    $("#cmx_directory_intro #splash_search_tags > div").click(function(e) {
        var search_string = $(this).text();
        $("#directory_filter_search .glyphicon").removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down");
        $("#directory_header_search_wrapper #partner-search-string").val(search_string);
        url_param_redirect();
    });
    $("#partner_acct_directory_close").click(function(e) {
        $("#home_directory_search_modal").hide();
    });
    //checkbox nav active or not active
    $("#directory_nav_wrapper li .partner_directory_checked, .show_search_on_home_page li .partner_directory_checked").click(function(e) {
        window.page = 1; //we made a change in filtering so reset page
        $(".partner_block_wrapper").show();
        if ($(this).closest("li").hasClass("active")) {
            $(this).closest("li").removeClass("active");
            $(this).closest("li").css({"color":"initial"});
            $(this).removeClass("glyphicon-check").addClass("glyphicon-unchecked");
            $(this).closest("li").find(".active").removeClass("active").css({"color":"initial"});
            $(this).closest("li").find(".partner_directory_checked").removeClass("glyphicon-check").addClass("glyphicon-unchecked");
            var el = $(this).closest("li").parent().closest("li");
            while(el.length > 0) {
                el.removeClass("active");
                el.css({"color":"initial"});
                el.find(".partner_directory_checked").first().removeClass("glyphicon-check").addClass("glyphicon-unchecked");
                el = el.parent().closest("li");
            }
        }else{
            $(this).closest("li").addClass("active");
            $(this).removeClass("glyphicon-unchecked").addClass("glyphicon-check");
            $(this).closest("li").find("li").addClass("active");
            $(this).closest("li").find(".partner_directory_checked").removeClass("glyphicon-unchecked").addClass("glyphicon-check");
        }
        hide_show_clear_filters();
        url_param_redirect();
    });
    //open close nav tree
    $("#directory_nav_wrapper li .open_menu, #home_directory_search_nav li .open_menu").click(function(e) {
        if ($(this).children(".open_menu_indicator").children(".glyphicon").hasClass("glyphicon-chevron-down")) {
            $(this).children(".open_menu_indicator").children(".glyphicon").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right");
            $(this).closest("li").children("ul").hide();
        }else{

            if(typeof match_content_to_nav_height === "function"){
                match_content_to_nav_height();
            }

            if ($(this).closest("li").children("ul").find("li").length != 0) {
                $(this).closest("li").children("ul").show();
                $(this).children(".open_menu_indicator").children(".glyphicon").removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down");
            }
        }
    });

    $(document).on("click", ".dir_filter_child.dir_filter_item", function(event){
        window.page = 1; //we made a change in filtering so reset page
        $(this).closest(".dir_filter_outer_wrapper").find(".dir_filter_item").removeClass("selected_filter");
        var tid = $(this).attr("tid");
        var tag_name = $(this).children(".filter_tag_name").text();
        $(this).addClass("selected_filter");
        $(this).closest(".dir_filter_outer_wrapper").children(".dir_filter_parent").attr("tid",tid).children(".filter_tag_name").text(tag_name);
        $(this).closest(".dir_filter_wrapper").hide();
        //should we show or hide clear filters?
        hide_show_clear_filters();
        url_param_redirect();
    });

    $(document).on("click", "#clear_directory_filters", function(event){
        window.page = 1; //we made a change in filtering so reset page
        $(".dir_filter_outer_wrapper > .dir_filter_parent.dir_filter_item").each(function () {
            var current_this = $(this);
            $(current_this).attr("tid","ALL");
            $(current_this).children(".filter_tag_name").text("ALL");
        });
        $("#directory_nav_wrapper li, #home_directory_search_nav li").removeClass("active");
        $("#directory_nav_wrapper .partner_directory_checked, #home_directory_search_nav .partner_directory_checked").removeClass("glyphicon-checked").addClass("glyphicon-unchecked");
        $("#clear_directory_filters_wrapper").remove();
        $(".dir_filter_item").removeClass("selected_filter");
        update_partners(false);
        if($("#account_block_result_output").length != 0){
            $("#account_block_result_wrapper").hide();
            $("#account_block_result_wrapper .notices").html("");
            $("#account_block_result_wrapper #account_block_result_output").html("");
            set_accounts_to_init();
        }
    });

    //filter toggles and actions
    $(".dir_filter_parent").on({
        mouseenter: function () {
            $(this).children(".dir_filter_wrapper").show();
        },
        mouseleave: function () {
            $(this).children(".dir_filter_wrapper").hide();
        }
    });
    $(".dir_filter_child").on({
        mouseenter: function () {
            $(this).addClass("filter_focus");
        },
        mouseleave: function () {
            $(this).removeClass("filter_focus");
        }
    });

    $("#splash_search_radio").click(function(event){
        $("#splash_chat_radio").prop("checked", false);
        $("#cmx_directory_intro #splash_chat_box").hide();
        $("#splash_chat_sample_questions").hide();
        $("#cmx_directory_intro .partner-search").css({"display":""});
        $("#splash_search_tags_intro").css({"display":""});
        $("#splash_search_tags").css({"display":""});
    });
    $("#splash_chat_radio").click(function(event){
        $("#splash_search_radio").prop("checked", false);
        $("#cmx_directory_intro .partner-search").hide();
        $("#splash_search_tags_intro").hide();
        $("#splash_search_tags").hide();
        $("#cmx_directory_intro #splash_chat_box").css({"display":""});
        $("#splash_chat_sample_questions").css({"display":""});
    });

});





    window.items_full_count = 0;
    window.local_items_full_count = 0;
    window.items_page = 1;
    window.accounts_page = 1;
    window.items_max_page = 10;
    window.getting_items = false;
    window.getting_accounts = false;
    window.pending_getting_item_request = false;
    window.pending_getting_accounts_request = false;

    window.content_type_message = 1;
    window.content_type_url = 2;
    window.content_type_video = 3;
    window.content_type_picture = 4;
    window.content_type_article = 5;
    window.content_type_document = 6;
    window.content_type_slideshare = 10;
    window.content_type_coupon = 11;
    window.content_type_email = 12;
    window.content_type_promotion = 13;
    window.content_type_icalendar = 14;

    function set_to_init(){
        window.getting_items = false;
        var current_number_of_items = $("#items_block_result_output .directory_item_block").length;
        if(current_number_of_items != 0 || $("#items_block_result_wrapper .notices").text() != ""){
            $("#items_block_result_wrapper").show();
            if($("#partner_directory_wrapper").hasClass("ai_not_enabled")){
                $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
            }
        }else{
            $("#items_block_result_wrapper").hide();
            if($("#partner_directory_wrapper").hasClass("ai_not_enabled")){
                $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").hide();
            }
        }
        $("#items_block_result_wrapper #load_more .load_more_loading").css({"display":"none"});
    }

    function set_accounts_to_init(){
        window.getting_accounts = false;
        $(".view_partners").removeClass("disabled");
        var current_number_of_accounts = $("#account_block_result_output .partner_block").length;
        if(current_number_of_accounts != 0 || $("#account_block_result_wrapper .notices").text() != ""){
            $("#account_block_result_wrapper").show();
        }else{
            $("#account_block_result_wrapper").hide();
        }
        $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"none"});
    }

    function update_partners(more, command = "get_partner_directory_and_content_entries")
    {
        $("#ai_account_notices").hide();
        $(".ai_partner_block_wrapper").html("").hide();
        if (command == "get_partner_directory_and_content_entries"){ 
            //we are getting items and accounts
            if (!more) {
                // clear the directory results
                $("#items_block_result_output").html("");
                $("#account_block_result_output").html("");
                $("#items_block_result_wrapper .notices").html("").hide();
                $("#account_block_result_wrapper .notices").html("").hide();
                $(".ai_partner_block_wrapper").hide().html("");
                $("#ai_account_notices").html("").hide();
                window.page = 1;
                window.items_page = 1;
            }
            if (!window.getting_items) {
                window.getting_items = true;
                $("#items_block_result_wrapper").show();
                $("#account_block_result_wrapper").show();
                $("#items_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
                $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
                $("#account_block_result_wrapper").addClass("results_from_account"); //mark it as coming from account
                partner_command("get_partner_directory_and_content_entries");
            }
        } else if(command == "get_partner_content_entries"){
            //we are getting items
            if (!more) {
                // clear the directory results
                $("#items_block_result_output").html("");
                $("#account_block_result_output").html("");
                $("#items_block_result_wrapper .notices").html("").hide();
                $("#account_block_result_wrapper .notices").html("").hide();
                $(".ai_partner_block_wrapper").hide().html("");
                $("#ai_account_notices").html("").hide();
                window.page = 1;
            }
            if(window.items_page == 1){
                $("#items_block_result_wrapper .notices").hide();
                $("#account_block_result_wrapper .notices").hide();
            }
            if (!window.getting_items) {;
                window.getting_items = true;
                $("#items_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
                partner_command("get_partner_content_entries");
            } else {
                window.pending_getting_items_request = true;
            }
        } else if(command == "get_partner_content_accounts"){ 
            //we are getting accounts
            if (!more) {
                // clear the directory results
                $("#account_block_result_output").html("");
                window.page = 1;
            }
            if(window.accounts_page == 1){
                $("#account_block_result_wrapper .notices").hide();
            }
            if (!window.getting_accounts) {
                window.getting_accounts = true;
                $(".view_partners").addClass("disabled");
                $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
                partner_command("get_partner_content_accounts");
            } else {
                window.pending_getting_accounts_request = true;
            }
        } else if(command == "get_partner_directory_entries"){
            //we are scrolling accounts
            if (!more) {
                window.page = 1;
            }
            if (!window.getting_accounts) {
                window.getting_accounts = true;
                $(".view_partners").addClass("disabled");
                $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"flex"});
                partner_command("get_partner_directory_entries_mode_items");
            } else {
                window.pending_getting_accounts_request = true;
            }
        }
    }

    function validate_item_call_data(data){
        if (
            ("filter_tags" in data && data.filter_tags.length > 0) || 
            ("form_ids" in data && data.form_ids.length > 0) || 
            ("tag_ids_account" in data && data.tag_ids_account.length > 0) || 
            ("tag_ids_channel" in data && data.tag_ids_channel.length > 0) || 
            ("search" in data && data.search != "")
        ) {
            return true;
        }else{
            $("#items_block_result_wrapper .notices").text("");
            set_to_init();
            set_accounts_to_init();
            return false;
        }
    }

    function validate_account_call_data(data){
        if ("iid" in data && data.iid != "")
        {
            return true;
        }else{
            $("#account_block_result_wrapper .notices").text("");
            set_accounts_to_init()
            return false;
        }
    }

    window.items_full_count = 0;
    window.items_page = 1;
    window.items_max_page = 10;
    
    function directory_items_listings_render(data){

        //if we also have account data we render that
        if("accounts" in data){
            $("#partner_directory_wrapper.ai_enabled").removeClass("wide_initial_ai_width");
            directory_accounts_listings_render(data, true);
            if (typeof set_accounts_to_init === "function"){
                //this is an items mode function
                set_accounts_to_init();
            }
        }

        //which directory sort are we in?
        window.partner_directory_sort_filtering = 0;
        if("partner_directory_sort_filtering" in data){
            window.partner_directory_sort_filtering = data.partner_directory_sort_filtering;
        }

        //set full page count
        if("full_items_count" in data){
            if(data.full_items_count != window.items_full_count && (window.partner_directory_sort_filtering != 2 && window.partner_directory_sort_filtering != 3)){
                window.page = 1;
            }
            window.items_full_count = data.full_items_count;
        }

        //what is the local item count?
        if("local_items_full_count" in data){
            if(data.local_items_full_count != window.local_items_full_count && (window.partner_directory_sort_filtering == 2 || window.partner_directory_sort_filtering == 3)){
                window.page = 1;
            }
            window.local_items_full_count = data.local_items_full_count;
        }

        var block_output = "";
        if ("items" in data && data.items.length == 0) {
            $("#items_block_result_wrapper .notices").show().html("There was no content matching your criteria");
        } else {
            if(typeof(data.items) != "undefined"){
                var temp_type_name_arry = [];
                $("#partner_directory_wrapper.ai_enabled").removeClass("wide_initial_ai_width");
                $("#items_block_result_output").css({"display":""});
                var render_item = 1;
                var bookmarked_class= "";
                var bm_attribute= "";
                var bm_glyphicon = "glyphicon-heart";
                data.items.forEach(function (item, index) {
                    render_item = 1;
                    if("is_published_by_child_or_not_child" in item && (window.partner_directory_sort_filtering == 2 || window.partner_directory_sort_filtering == 3)){
                        if(item.is_published_by_child_or_not_child != 1){
                            render_item = 0;
                        }
                    }

                    if(render_item == 1){
                        block_output = "";
                        block_output += "<div class=\"directory_item_block\" pub_type=\""+item.is_published_by_child_or_not_child+"\" item_type_id=\""+item.item_type_id+"\" iid=\""+item.item_id+"\">";
                        if("bookmark_id" in item && item.bookmark_id != ""){
                            bookmarked_class = " bookmarked";
                            bm_attribute = item.bookmark_id;
                            bm_glyphicon = "glyphicon-heart";
                        }else{
                            bookmarked_class = "";
                            bm_attribute = "";
                            bm_glyphicon = "glyphicon-heart-empty";
                        }
                        block_output += "<span class=\"glyphicon "+bm_glyphicon+" cmx-bookmark"+bookmarked_class+"\" bm=\""+bm_attribute+"\" ot=\"1\" oid=\""+item.item_id+"\" aria-hidden=\"true\"></span>";
                        block_output += "<div class=\"item_text_col\">";
                        if (item.campaign_id != 0) {
                            block_output += "<div class=\"item_type\"><span class=\"glyphicon glyphicon-envelope\"></span></div>";
                        }
                        block_output += "<div class=\"item_channel\">"+item.channel_name+"</div>";
                        if (item.campaign_id != 0 && item.email_subject != "") {
                            block_output += "<span class=\"item_title\">"+item.email_subject+"</span>";
                        } else {
                            block_output += "<span class=\"item_title\">"+item.item_title+"</span>";
                        }
                        block_output += "<div class=\"description\" style=\"display:none;\">"+item.description+"</div>";
                        block_output += "<div class=\"view_button\"><a href=\"#\" type=\"button\" style=\"color:#fff; display:inline-block;\" class=\"view_modal btn btn-primary btn-sm\">View Content</a> </div>";
                        block_output += "<div style=\"margin-top: 7px;\">";
                        block_output += score_html(item.score, item.search_token_cnt);
                        block_output += "</div>";
                        block_output += "</div>";
                        block_output += "<div class=\"item_image_col\">";
                        temp_type_name_arry = item.type_name.split("|");
                        if(typeof temp_type_name_arry[1] !== "undefined"){
                            item.type_name = temp_type_name_arry[1].trim();
                            if(item.type_name == "Build Your List") {
                                item.type_name = "Free Premium Content";
                            }
                        }
                        block_output += "<div class=\"item_type_label\">"+item.type_name+"</div>";
                        /*
                        if (item.campaign_id != 0 && item.email_thumb_url != "") {
                            block_output += "<img src=\""+item.email_thumb_url+"\" onerror=\"img_error_replace(this);\" alt=\""+item.type_name+"\">";
                        } else
                        */ 
                        if (item.media_fb_thumb_url != "" && (item.campaign_id != 0 || item.item_type_id == "6")) { 
                            block_output += "<img src=\""+item.media_fb_thumb_url+"\" onerror=\"img_error_replace(this);\" alt=\""+item.type_name+"\">";
                        } else {
                            block_output += "<img src=\""+item.thumbnail_url+"\" onerror=\"img_error_replace(this);\" alt=\""+item.type_name+"\">";
                        }      
                        block_output += "</div>";
                        block_output += "</div>";
                        $("#items_block_result_output").append(block_output);
                        if($("#directory_ai_search .radio_circle").length > 0 && $("#directory_ai_search .radio_circle").hasClass("active")){
                            adjust_ai_chat_layout(); //adjust layout after results for partner case
                        }
                    }

                });
                if(window.items_page == 1){ 
                    $("#items_block_result_wrapper").show();
                    if((window.partner_directory_sort_filtering == 2 || window.partner_directory_sort_filtering == 3)){
                        if(window.partner_directory_sort_filtering == 2){
                            if(window.local_items_full_count < data.full_items_count){
                                $("#items_block_result_wrapper .notices").show().html(window.local_items_full_count+" recommended items matching your criteria found here (we have found another "+data.full_items_count+" more matching items on <a style=\"color:#3c77b9; text-decoration:underline;\" id=\"home_directory_parent_link\" href=\"https://partneron.com\">PartnerOn</a>)");
                            }else{
                                $("#items_block_result_wrapper .notices").show().html(window.local_items_full_count+" recommended items matching your criteria");
                            }
                        }else{
                            $("#items_block_result_wrapper .notices").show().html(window.local_items_full_count+" recommended items matching your criteria");
                        }
                    }else{
                        $("#items_block_result_wrapper .notices").show().html(data.full_items_count+" recommended items matching your criteria");
                    }
                }
//
            }
        }

        //do we need to put up an ai notification?
        if ($(".ai_partner_block_wrapper .partner_block").length > 0) {
            var ai_partner_block_count = $(".ai_partner_block_wrapper .partner_block").length;
            $("#ai_account_notices").show().html(ai_partner_block_count+" AI recommended partners");
        } else {
            $("#ai_account_notices").hide();
        }

        window.getting_items = false;
    }

    window.accounts_full_count = 0;
    window.accounts_page = 1;
    window.accounts_max_page = 30;

    function directory_accounts_listings_render(data, is_query){
        $("#account_block_result_output").css({"display":""});
        if("full_accounts_count" in data){
            if(data.full_accounts_count != window.accounts_full_count){
                window.page = 1;
                window.accounts_page == 1
            }
            window.accounts_full_count = data.full_accounts_count;
        }

        var block_output = "";
        if (data.accounts == "") {
            if (is_query) {
                if (data.full_items_count > 1) {
                    $("#account_block_result_wrapper .notices").show().html("There were no partners matching your criteria. Please select the View Partners button on one of the content items listed on the left to see the partners who published this content.");
                } else if (data.full_items_count == 1) {
                    setTimeout(() => {
                        $(".view_partners").click();
                    }, 100);
                } else {
                    $("#account_block_result_wrapper .notices").show().html("There were no partners matching your criteria");
                }
            } else {
                $("#account_block_result_wrapper .notices").show().html("No partners have published this content yet");
            }
            $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"none"});
        } else {
   
            $("#account_block_result_output").append(data.accounts);

            if(window.accounts_page == 1){
                $("#account_block_result_wrapper").show();
                if (is_query) {
                    $("#account_block_result_wrapper .notices").show().html(data.full_accounts_count+" recommended partners matching your criteria");
                } else {
                    $("#account_block_result_wrapper .notices").show().html(data.full_accounts_count+" recommended partners published this content");
                }
                $("#account_block_result_wrapper #load_more .load_more_loading").css({"display":"none"});
            }

        }

        window.getting_accounts = false;
        $(".view_partners").removeClass("disabled");
    }

    function match_content_to_nav_height(){
        setTimeout(function() {

            if($("#home_directory_search_nav").length > 0){
                var nav_height = $("#home_directory_search_nav").height();
            }else{
                var nav_height = $("#directory_sidebar_wrapper").height();
            }
            
            if(nav_height > 600){
                $("#items_block_result_wrapper").css({"max-height": nav_height+"px"});
                $("#account_block_result_wrapper").css({"max-height": nav_height+"px"});
            }
        }, 1000);
    }
               
    function sign_in() {
        tmp_html = "<h1 style=\"margin-top: 0px;\">";
        tmp_html += "Almost there!"; 
        tmp_html += "</h1><br>";
        tmp_html += "You are just one step away from some great stuff. To retrieve this content, please sign in.";                
        displayVisitorSignInDialog(tmp_html);
    };

    /*function update_download_links() {

        if ($("#modal_content_action").length > 0) {
            // we have a modal to update
            var iid = $("#modal_content_action").data("iid");
            var item_type_id = $("#modal_content_action").data("item-type-id");

            // do ajax command to get the link data if allowed to have it
            var data = { 
                "command": "get_partner_content_entry",
                "pa_id": 13818,
                "iid": iid,
                "mid": window.known_member_id,
                "update": true,
                "ssid": window.search_session_id,
                "sssid": window.sub_search_session_id
            };

            $.ajax({
                type: "POST",
                url: "https://contentmx.com/b/partner_directory_commands.php",
                data: data,
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function(data) {
                    var is_item = false;
                    if ("item" in data) {
                        is_item = true;
                        var download_url = data.item.url_original;
                        var encoded_content_bundle = data.item.encoded_content;
                        var link_url = data.item.url;
                    }                         
                    
                    var new_button = "";    
                    //what button do we use?
                    if (is_item) {
                        if (item_type_id == window.content_type_url) {
                            new_button = "<a id=\"dir_item_link_button\" type=\"button\" href=\""+link_url+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">View Link</a>";
                        } else if(item_type_id == window.content_type_picture || item_type_id == window.content_type_document) {
                            new_button = "<a id=\"dir_item_download_button\" type=\"button\" href=\""+download_url+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">Download</a>";
                            var pdf_test_string = download_url.toLowerCase();
                            if (pdf_test_string.indexOf(".pdf") != -1) {
                                new_button += "<a id=\"dir_item_download_button\" type=\"button\" href=\""+encoded_content_bundle+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">Download</a>";
                            }else{
                                new_button += "<a id=\"dir_item_download_button\" type=\"button\" href=\""+download_url+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">Download</a>";
                            }

                        }
                    } else {
                        if (item_type_id == window.content_type_url) {
                            new_button =  "<a type=\"button\" style=\"color:#fff;\" class=\"btn btn-primary\" onclick=\"sign_in()\" data-iid=\""+iid+"\">View Link</a>";
                        } else if(item_type_id == window.content_type_picture || item_type_id == window.content_type_document) {
                            new_button =  "<a type=\"button\" style=\"color:#fff;\" class=\"btn btn-primary\" onclick=\"sign_in()\" data-iid=\""+iid+"\">Download</a>";
                        }
                    }
                    $("#modal_content_action").html(new_button);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }
            });
        }
    };*/

    //on load event
    document.addEventListener("DOMContentLoaded", () => {

        //on scroll items
        $("#items_block_result_wrapper").on("scroll", function() {
            if(window.partner_directory_sort_filtering == 2 || window.partner_directory_sort_filtering == 3){
                // console.log("local items");
                var this_items_fill_count = window.local_items_full_count;
            }else{
                // console.log("all items");
                var this_items_fill_count = window.items_full_count;
            }
            var current_number_of_items = $("#items_block_result_output .directory_item_block").length;
            // console.log(current_number_of_items,this_items_fill_count);
            if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight-5 && (this_items_fill_count > window.items_max_page) && current_number_of_items < this_items_fill_count) {
                if(window.cmx_prevent_item_load_on_scroll == 0 && !window.getting_items){
                    window.items_page++;
                    update_partners(true, "get_partner_content_entries");
                }
            }
        });

        match_content_to_nav_height(); //match height

        //on scroll accounts
        $("#account_block_result_wrapper").on("scroll", function() {
            var current_number_of_accounts = $("#account_block_result_output .partner_block").length;
            if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight-5 && (window.accounts_full_count > window.accounts_max_page) && current_number_of_accounts < window.accounts_full_count) {
                if(window.cmx_prevent_account_load_on_scroll == 0 && !window.getting_accounts){
                    window.accounts_page++;
                    if($(this).hasClass("results_from_account")){
                        update_partners(true, "get_partner_directory_entries");
                    }else{
                        update_partners(true, "get_partner_content_accounts");
                    }
                }
            }
        });

        //on click home_directory_parent_link 
        $(document).on("click", "#home_directory_parent_link", function(event) {
            event.preventDefault();
            var home_directory_parent_link = $(this).attr("href");
            var url_obj = new URL(home_directory_parent_link);
            var dir = url_obj.searchParams.get("dir");
            var i = url_obj.searchParams.get("i");
            var u = url_obj.searchParams.get("u");
            home_directory_parent_link = url_obj.origin;
            var page_params = [];
            if(u != null){
                page_params.push("u="+u);
            }
            if(i != null){
                page_params.push("i="+i);
            }
            if(dir == 1){
                page_params.push("dir="+dir);
            }
            if($("#partner-search-string").val() != ""){
                page_params.push("q="+$("#partner-search-string").val());
            }
            page_params = page_params.join("&");
            if(page_params != ""){
                page_params = "?"+page_params;
            }
            window.open(home_directory_parent_link+page_params, "_blank").focus();

        });
        
        //on click View Link Button
        $(document).on("click", "#dir_item_link_button", function(event) {
            event.preventDefault();

            var item_type = $(this).closest("#modal_content_action").attr("data-item-type-id");
            var iid = $(this).closest("#modal_content_action").attr("data-iid");
            var href = $(this).attr("href");

            //if external link do we open a modal or push to a link?
            if(item_type == window.content_type_url){
                link_display_router(this, iid);
            }else{
                window.open(href, "_blank");
            }
            
            var pspcu = "https://contentmx.com/b/page_commands.php";
            var iid = $(this).data("iid");
            $.get(pspcu+"?command=page_activity&type=directory_linkview&i="+iid+"&m="+window.known_member_id+"&aid="+13818+"&ssid="+window.search_session_id);
        });
        
        //on click Download Button
        $(document).on("click", "#dir_item_download_button", function(event) {
            var pspcu = "https://contentmx.com/b/page_commands.php";
            var iid = $(this).data("iid");
            $.get(pspcu+"?command=page_activity&type=directory_download&i="+iid+"&m="+window.known_member_id+"&aid="+13818+"&ssid="+window.search_session_id);
        });

        //on click view doc button
        $(document).on("click", "#dir_item_view_doc_button", function(event) {
            event.preventDefault();
            //open in iframe
            var url = $(this).attr("href");
            var iframe = display_link_in_frame(url);
            $("#item_display_modal").append("<div id=\"modal_iframe_wrapper\">"+iframe+"</div>").css({"width":"100%", "max-width":"1000px"});
            $("#modal_content").hide();
            var pspcu = "https://contentmx.com/b/page_commands.php";
            var iid = $(this).data("iid");
            $.get(pspcu+"?command=page_activity&type=directory_download&i="+iid+"&m="+window.known_member_id+"&aid="+13818+"&ssid="+window.search_session_id);
        });

        function link_display_router(this_button, iid){ 
            var data = { 
                "command": "get_partner_content_entry_url",
                "pa_id": 13818,
                "iid": iid
            };
            $.ajax({
                type: "POST",
                url: "https://contentmx.com/b/partner_directory_commands.php",
                data: data,
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function(data) {
                    console.log(data.item_url);
                    var item_url = "";
                    var can_embed = 0;
                    if("item_url" in data){
                        if(data.item_url != ""){
                            item_url = data.item_url;
                        }
                    }
                    if("can_embed" in data){
                        can_embed = data.can_embed;
                    }

                    if(item_url != ""){
                        if(can_embed == 1){
                           var cmx_iframe = display_link_in_frame(item_url);
                           show_directory_item_modal(this_button, cmx_iframe)
                        }else{
                            window.open(item_url, "_blank");
                        }
                    }else{
                        alert("Unable to fetch link.");
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert("Unable to fetch link.");
                }
            });
        }

        function display_link_in_frame(url){
            var cmx_iframe = "<iframe id=\"cmx_inline_link_frame\" width=\"300\" height=\"200\" src=\""+url+"\"></iframe>";
            return cmx_iframe;
        }

        //on click item view
        $("#items_block_result_output").on("click", ".directory_item_block .view_modal", function(event){
            event.preventDefault();
            if($(this).closest("#home_directory_search_modal").length != 0){
                if($(this).closest(".directory_item_block").attr("pub_type") == 1){
                    var this_button = $(this);
                    var this_item_type = $(this).closest(".directory_item_block").attr("item_type_id");
                    var iid = $(this).closest(".directory_item_block").attr("iid");
                    var data = { 
                        "command": "get_partner_content_entry_url",
                        "pa_id": 13818,
                        "iid": iid
                    };
                    $.ajax({
                        type: "POST",
                        url: "https://contentmx.com/b/partner_directory_commands.php",
                        data: data,
                        dataType: "json",
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function(data) {
                            console.log(data.item_url);
                            var item_url = "";
                            var can_embed = 0;
                            if("item_url" in data){
                                if(data.item_url != ""){
                                    item_url = data.item_url;
                                }
                            }
                            if("can_embed" in data){
                                can_embed = data.can_embed;
                            }
    
                            if(item_url != ""){
                                if(this_item_type == window.content_type_url && can_embed == 1){
                                   var cmx_iframe = display_link_in_frame(item_url);
                                   show_directory_item_modal(this_button, cmx_iframe)
                                }else{
                                    window.open(item_url, "_blank");
                                }
                            }else{
                                $(this_button).after( "<span class=\"directory_link_error\" style=\"color:red;\"> Unable to fetch url.</span>" );
                                setTimeout(function () {
                                    $(".directory_link_error").remove();
                                }, 1000);
                            }
                        
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            $(this_button).after( "<span class=\"directory_link_error\" style=\"color:red;\"> Unable to fetch url.</span>" );
                            setTimeout(function () {
                                $(".directory_link_error").remove();
                            }, 1000);
                        }
                    });
                }else{
                    show_directory_item_modal(this);
                }
                //partner case

            }else{
                show_directory_item_modal(this);
            }

        });
        //on click item view
        $("#items_block_result_output").on("click", ".directory_item_block .view_partners", function(event){
            event.preventDefault();
            if(window.getting_accounts == false){ 
                $(this).addClass("active_account_search");
                $(".directory_item_block").removeClass("active");
                $(this).closest(".directory_item_block").addClass("active");
                $("#account_block_result_wrapper").show();
                //get_partner_directory_entries //iid
                update_partners(false, "get_partner_content_accounts"); 

            }
        });
        //on click item view accounts. clicked account and want to see published item
        $("#account_block_result_output").on("click", "a.partner_block_link", function(event){
            event.preventDefault();
            var link_this = this;
            if($(".view_partners.active_account_search").length > 0){
                //get local partner url of item
                var iid = $(".view_partners.active_account_search").closest(".directory_item_block").attr("iid");
                var vaid = $(this).attr("data-vaid");
                //ktg
                var data = { 
                    "command": "get_partner_item_page_url", 
                    "pa_id": vaid,
                    "iid": iid
                };

                    $.ajax({
                        type: "POST",
                        url: "https://contentmx.com/b/partner_directory_commands.php",
                        data: data,
                        dataType: "json",
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function(data){  
                            if("url" in data && data.url != ""){
                                window.open(data.url, "_blank").focus();
                            }else{
                                window.open($(link_this).attr("href"), "_blank").focus();
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) { 
                            window.open($(link_this).attr("href"), "_blank").focus();
                        }       
                    });

            }else{
                //just do to the url in the link
                window.open($(link_this).attr("href"), "_blank").focus();
            }
        });
        //close modal
        $(document).on("click", "#item_display_modal #close_modal, #item_display_modal_underlay", function(event){
            $("#item_display_modal").hide();
            $("#item_display_modal_underlay").hide();
            $("#item_display_modal #modal_content").html("");
            $("#modal_content").show();
            $("#modal_iframe_wrapper").remove().css({"width":"", "max-width":""});
        });

        var item_display_modal = "<div id=\"item_display_modal\" style=\"display:none;\"><div id=\"close_modal\">x</div>";
        item_display_modal += "<div id=\"modal_content\"></div>";
        item_display_modal += "</div>";
        item_display_modal += "<div id=\"item_display_modal_underlay\" style=\"display:none;\"></div>";
        $("body").append(item_display_modal);

        window.cmx_prevent_item_load_on_scroll = 0;
        window.cmx_prevent_account_load_on_scroll = 0;
        //whimsy config
                window.start_whimsy = [];
                window.start_whimsy[0] = "<p>You're on your way...</p><p>Let's chat to find the information and content you are looking for. I will use my smarts to assist with your search.</p>";
                window.start_whimsy[1] = "<p>Here we go!</p><p>Tell me more about the problem you are trying to solve. I will show you relevant content that can help you implement your wishes.</p>";
                window.no_results_has_keywords_whimsy = [];
                window.no_results_has_keywords_whimsy[0] = "<p>No results yet...</p><p>The selected keywords have not found a match. You can chat to change the search or maybe there is no content matching your needs at this time.</p>";
                window.no_results_has_keywords_whimsy[1] = "<p>Hmm...</p><p>Seems like I am not finding anything right now. Maybe you can describe the problem more generally or ask me to try some less specific keywords.</p>";
                window.no_results_no_keywords_whimsy = [];
                window.no_results_no_keywords_whimsy[0] = "<p>Let's keep thinking...</p><p>Tell me more about the problem you are trying to solve.</p>";
                window.no_results_no_keywords_whimsy[1] = "<p>Ok, I think I need a little more information to come up with some recommendations.</p>";
                

            function directory_create_chat() {
                var output = "";
            
                    output += "<div class=\"answer-wrapper\" style=\"display:none;\">";
                    output += "<div id=\"answer\"><div class=\"talk-bubble ai initial_ai_prompt\"><div class=\"talktext\">Please describe the problem you are trying to solve.</div></div></div>";
                
                output += "</div>";
                output += "<div class=\"form-group ai-question-field-wrapper\" style=\"padding:20px 0 0 0;\">";
                output += "<input name=\"question\" class=\"form-control\" id=\"question\" val=\"\">";
                output += "<button type=\"button\" class=\"btn btn-primary\" id=\"directory_ask_question\"><span class=\"glyphicon glyphicon-circle-arrow-up\" aria-hidden=\"true\"></span></button>";
                output += "</div>";
                output += "<div id=\"ai_disclaimer\">";
                output += "You are using an AI that may or may not be fully capable of answering every question correctly.";
                output += "</div>";
                output += "<div id=\"ask_status\" class=\"form-group\" style=\"display: none;\">";
                output += "</div> ";
                output += "<div class=\"ai_reset_wrapper\">";
                output += "<button type=\"button\" id=\"ai_reset\" style=\"display:none;\" class=\"btn btn-info btn-sm\">Reset Chat</button>";
                output += "</div>";

                $("#directory_ai_thread").html(output);
            }

            function abort_ai_request() {
                if(typeof window.current_ai_request !== "undefined"){
                    window.current_ai_request.abort();
                }
                if(typeof window.current_check_run_partner_directory !== "undefined"){
                    window.current_check_run_partner_directory.abort();
                }
            }
            $(document).on("click", "#ai_reset", function(event){
                event.preventDefault();
                $("#directory_whimsy").hide();
                window.prevent_check_run_partner_directory = 1;
                abort_ai_request();
                $("#directory_ask_question").removeClass("disabled");
                $("#question").prop("disabled", false);
                showing_ai_conversation = false;
                $("#ai_loader").remove();
                adjust_ai_chat_layout();
                init_ai_search(1);
                //partner case
                if($(".show_search_on_home_page").length > 0 && $("#items_block_result_output").text() == ""){
                    directory_render_whimsy();
                }
                //directory case
                if($(".partner_directory_page").length > 0){
                    if($("#items_block_result_output").text() == "" && $("#account_block_result_output").text() == ""){
                        directory_render_whimsy();
                    }
                }
            });
            $(document).on("click", "#directory_filter_search", function(event){
                $("#directory_whimsy").hide();
                abort_ai_request();
                var this_glyphicon = $(this).find(".glyphicon");
                if($(".show_search_on_home_page").length != 0){

                    $(".show_search_on_home_page_directory_wrap .partner-search .search-col-inner, .show_search_on_home_page_directory_wrap #home_directory_search_button").show()
                    $("#home_directory_ask_question_field, #home_directory_ask_question").hide();

                    this_glyphicon = $(this).find(".radio_circle");
                    //home case
                    if(!$(this_glyphicon).hasClass("active")){
                        $("#home_directory_search_modal #home_directory_search_nav").css({"display":"none"});
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
                        $(".show_search_on_home_page_directory_wrap #home_directory_search_nav > .directory_ul_nav_wrapper").show();
                        $(".directory_chat_wrapper").hide();
                        $("#home_directory_search_modal").removeClass("ai_enabled");
                        window.cmx_prevent_load_on_scroll = 0;
                        $("#directory_filters").show();
                        $(".directory_feature_listing_wrapper").show();
                        if($("#directory_notices .alert").text() != ""){
                            $("#directory_notices").show();
                        }

                        $(".partner_block_wrapper").show();

                        if (!showing_ai_conversation) {
                            $("#directory_ask_question").removeClass("disabled");
                        }
                        $(this_glyphicon).addClass("active");
                        $(".show_search_on_home_page_directory_wrap #directory_ai_search .radio_circle").removeClass("active");
                        $(".directory_chat_wrapper").hide();
                        $("#home_directory_search_modal").removeClass("ai_enabled");
                        $("#directory_ai_search").find("input").prop("checked", false);
                        $("#directory_nav_wrapper > .search-col").show();
                        if(typeof match_content_to_nav_height === "function"){
                            match_content_to_nav_height();
                        }
                    }else{
                        $("#home_directory_search_modal").hide();
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").hide();
                        $(this_glyphicon).removeClass("active");
                        $(".show_search_on_home_page_directory_wrap #home_directory_search_nav > .directory_ul_nav_wrapper").hide();
                    }



                }else{
                    
                    if($(this_glyphicon).hasClass("glyphicon-chevron-right")){
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
                        $(".directory_chat_wrapper").show();
                        $("#home_directory_search_modal").addClass("ai_enabled");
                        window.cmx_prevent_load_on_scroll = 0;
                        $("#directory_filters").show();
                        $(".directory_feature_listing_wrapper").show();
                        if($("#directory_notices .alert").text() != ""){
                            $("#directory_notices").show();
                        }
                        if($("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").length != 0){
                            //$("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                        }
                        $(".partner_block_wrapper").show();
    
                        //we have no results so fill with default 
                        if($("#items_block_result_output").html() == "" && $("#account_block_result_output").html() == ""){
                            update_partners(false);
                        }
                        
                        $(".search-col").show();
                        if (!showing_ai_conversation) {
                            $("#directory_ask_question").removeClass("disabled");
                        }
                        $(this_glyphicon).removeClass("glyphicon-chevron-right");
                        $(this_glyphicon).addClass("glyphicon-chevron-down");
                        $(".directory_chat_wrapper").hide();
                        $("#home_directory_search_modal").removeClass("ai_enabled");
                        $("#directory_ai_search").find(".glyphicon").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right");
                        $("#directory_nav_wrapper > .directory_ul_nav_wrapper").show();
                        $("#directory_nav_wrapper > .search-col").show();
                        if(typeof match_content_to_nav_height === "function"){
                            match_content_to_nav_height();
                        }
                    }else{
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").hide();
                        $(this_glyphicon).addClass("glyphicon-chevron-right");
                        $(this_glyphicon).removeClass("glyphicon-chevron-down");
                        $("#directory_nav_wrapper > .directory_ul_nav_wrapper").hide();
                        $("#directory_nav_wrapper > .search-col").hide();
                    }
                }

            });
            $(document).on("click", ".ai_sample_question", function(event){
                $("body").removeClass("active-splash-screen");
                var sample_question = $(this).text();
                $(".talk-bubble.ai.initial_ai_prompt").remove();
                $("#directory_ai_search").trigger("click");
                adjust_ai_chat_layout();
                ai_initiate_question(sample_question);
            });
            $(document).on("click", "#clear_directory_search", function(event){
                $("#partner-search-string").val("");
                $(this).hide();
            });
            $(document).on("click", "#directory_ai_search", function(event){ 
                var this_glyphicon = $(this).find(".glyphicon");
                if($(".show_search_on_home_page").length != 0){
                    //home case
                    this_glyphicon = $(this).find(".radio_circle");
                    if(!$(this_glyphicon).hasClass("active")){

                        $(".show_search_on_home_page_directory_wrap .partner-search .search-col-inner, .show_search_on_home_page_directory_wrap #home_directory_search_button").hide()
                        $("#home_directory_ask_question_field, #home_directory_ask_question").show();

                        $(".answer-wrapper").show();
                        $(".show_search_on_home_page_directory_wrap #home_directory_search_nav > .directory_ul_nav_wrapper").hide();
                        $("#item_block_wrapper").hide();
                        $("#partner_block_wrapper").hide();
                        $("#ai_partner_block_wrapper").show();
                        $("#directory_ai_thread").show();
                        $("#directory_filters").hide();
                        $("#directory_notices").hide();
                        if($("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").length != 0){
                            $("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                        }
                        $(".directory_feature_listing_wrapper").hide();
                        $(this_glyphicon).addClass("active");
                        $("#directory_sidebar_wrapper .directory_chat_wrapper").show();
                        $("#directory_filter_search").find(".radio_circle").removeClass("active");
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
                        $(".directory_chat_wrapper").show();
                        $("#home_directory_search_modal").addClass("ai_enabled");

                        $(".show_search_on_home_page #partner-search-string").val("");
                        $("#home_directory_search_title").hide();
                        $("#clear_directory_home_search").hide();
                        $("#clear_directory_search").hide();
                        $("#items_block_result_output").text("");
                        //do we adjust the width of the ai chat box or not?
                        adjust_ai_chat_layout();

                        window.cmx_prevent_load_on_scroll = 1;
                    }else{
                        $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").hide();
                        $(this_glyphicon).removeClass("active");
                        $(".directory_chat_wrapper").hide();
                        $("#home_directory_search_modal").removeClass("ai_enabled");
                        $("#home_directory_search_modal").hide();
                    }
                }else{
                    
                    $(".directory_chat_wrapper").hide();
                    $("#home_directory_search_modal").removeClass("ai_enabled");
                    $("#item_block_wrapper").hide();
                    $("#partner_block_wrapper").hide();
                    $("#ai_partner_block_wrapper").show();
                    $("#directory_filters").hide();
                    $("#directory_notices").hide();
                    if($("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").length != 0){
                        $("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                    }
                    $(".directory_feature_listing_wrapper").hide();
                    $(this).hide();
                    $("#directory_sidebar_wrapper .directory_chat_wrapper").show();
                    $("#directory_filter_search").find(".glyphicon").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right");
                    $("#directory_nav_wrapper > .directory_ul_nav_wrapper").hide();
                    $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
                    $("#directory_nav_wrapper > .search-col").hide();
                    window.cmx_prevent_load_on_scroll = 1;
                    show_ai_search();
                }

            });
            $(document).on("click", ".ai_close_button", function(event){
                $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").hide();
                $("#directory_whimsy").hide();
                $(".directory_chat_wrapper").hide();
                $("#home_directory_search_modal").removeClass("ai_enabled");
                $("#directory_ai_search").show();
                $(".show_search_on_home_page_directory_wrap #directory_content_wrapper").show();
                $("#directory_nav_wrapper").show();
                $(".directory_chat_wrapper").show();
                $("#home_directory_search_modal").addClass("ai_enabled");
                window.cmx_prevent_load_on_scroll = 0;
                $("#directory_filters").show();
                $(".directory_feature_listing_wrapper").show();
                if($("#directory_notices .alert").text() != ""){
                    $("#directory_notices").show();
                }
                $(".partner_block_wrapper").show();

                //we have no results so fill with default 
                if($("#items_block_result_output").html() == "" && $("#account_block_result_output").html() == ""){
                    update_partners(false);
                }

                $(".search-col").show();
                if (!showing_ai_conversation) {
                    $("#directory_ask_question").removeClass("disabled");
                }
                $(".directory_chat_wrapper").hide();
                $("#home_directory_search_modal").removeClass("ai_enabled");
                $("#directory_nav_wrapper > .directory_ul_nav_wrapper").show();
                $("#directory_nav_wrapper > .search-col").show();
                if(typeof match_content_to_nav_height === "function"){
                    match_content_to_nav_height();
                }
            });
            function show_ai_search(init = 0) {
                if(init == 1){
                    $("#directory_content_wrapper .directory_chat_wrapper").show();
                    $("#home_directory_search_modal").addClass("ai_enabled");
                }else{
                    $("#directory_ai_thread .answer-wrapper").css({"display":""});
                    $("#directory_ai_thread #answer").show();
                    $(".ai_partner_block_wrapper").show();
                    $(".partner_block_wrapper").hide();
                }
            }
            function init_ai_search(reset = 0) {
                window.ai_mode = "normal";
                // create a thread
                var formData = new FormData();
                formData.append("command", "create_thread");
                formData.append("mid", window.known_member_id);
                formData.append("curl", removeParam("ss", removeParam("cc", window.location.href)));
                var dat_id = window.directory_ai_thread_id;
                var dac_id = window.directory_ai_conversation_id;
                $.ajax({
                    "url": "https://contentmx.com/b/ai_assistant_commands.php",
                    "type": "post",
                    "data": formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (response) {
                        if (response.error == "") {
                            if(reset == 1){
                                $("#ai_reset").hide();
                                $(".talk-bubble").remove();
                                update_chat("Ready.", "ai-not-typed");
                                close_ai_thread(dat_id, dac_id);
                            }
                            window.directory_ai_thread_id = response.tid;
                            window.directory_ai_conversation_id = response.cid;
                            //directory_create_chat(); //we will render the form first. lock it. Unlock it when we recieve a resoponse. 
                        } else {
                            console.log("Create thread failed: " + response.error);
                            window.ai_mode = "search_forever";
                            clear_initial_screen();
                            // $("#directory_content_wrapper").html("");
                            show_ai_search();
                            update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("Create thread failed: " + textStatus);
                        window.ai_mode = "search_forever";
                        clear_initial_screen();
                        // $("#directory_content_wrapper").html("");
                        show_ai_search();
                        update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                    }
                });
            }
            function close_ai_thread(directory_ai_thread_id = "", directory_ai_conversation_id = "") {
                // close the thread
                if (directory_ai_thread_id != undefined && directory_ai_thread_id != null && directory_ai_thread_id != "") {
                    var formData = new FormData();
                    formData.append("command", "delete_thread");
                    formData.append("tid", directory_ai_thread_id);
                    formData.append("cid", directory_ai_conversation_id);
                    $.ajax({
                        "url": "https://contentmx.com/b/ai_assistant_commands.php",
                        "type": "post",
                        "data": formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.error == "") {
                            } else {
                                console.log("Delete thread failed: " + response.error);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log("Delete thread failed: " + textStatus);
                        }
                    });
                }
            }

            $("body").on("keyup", "#question", function(e) {
                if ((e.key == "Enter" || e.keyCode == 13)) {
                    $(this).closest(".ai-question-field-wrapper").find("#directory_ask_question").trigger("click");
                }
            });
            $("body").on("keyup", "#home_directory_ask_question_field", function(e) {
                $("#directory_whimsy").hide();
                if ((e.key == "Enter" || e.keyCode == 13)) {
                    if($("#items_block_result_output").text() == ""){
                        directory_render_whimsy();
                    }
                    $("#home_directory_search_modal #home_directory_search_nav").css({"display":""});
                    $("#home_directory_search_modal").show();
                    var search_string = $(this).val();
                    $(this).val("");
                    $("#question").val(search_string);
                    $("#directory_ask_question").trigger("click");
                }
            });
            $(document).on("click", "#home_directory_ask_question", function(event){
                $("#directory_whimsy").hide();
                if($("#items_block_result_output").text() == ""){
                    directory_render_whimsy();
                }
                $("#home_directory_search_modal #home_directory_search_nav").css({"display":""});
                $("#home_directory_search_modal").show();
                var search_string = $("#home_directory_ask_question_field").val();
                $("#home_directory_ask_question_field").val("");
                $("#question").val(search_string);
                $("#directory_ask_question").trigger("click");
            });
            $("body").on("keyup", "#splash_question", function(e) {
                if ((e.key == "Enter" || e.keyCode == 13)) {
                    $(".talk-bubble.ai.initial_ai_prompt").remove();
                    $("body").removeClass("active-splash-screen");
                    var sample_question = $(this).text();
                    $("#directory_ai_search").trigger("click");
                    adjust_ai_chat_layout();
                    ai_initiate_question($(this).val());
                }
            });
            $(document).on("click", "#splash_ask_question", function(event){
                $("body").removeClass("active-splash-screen");
                var sample_question = $(this).text();
                $(".talk-bubble.ai.initial_ai_prompt").remove();
                $("#directory_ai_search").trigger("click");
                adjust_ai_chat_layout();
                ai_initiate_question($(this).closest("#splash_chat_box").find("#splash_question").val());
            });
      
            function ai_initiate_question(question){
                clear_directory_splash_screen();
                window.prevent_check_run_partner_directory = 0;

                $("#directory_whimsy").hide();
                if($(".partner_directory_page").length > 0){
                    if($("#items_block_result_output").text() == "" && $("#account_block_result_output").text() == ""){
                        directory_render_whimsy(); //add dir whimsy
                    }
                }
                if($(".show_search_on_home_page").length > 0 && $("#items_block_result_output").text() == ""){
                    directory_render_whimsy(); //add partner whimsy
                }

                if(validate_ai_question(question)){
                    $("#ai_reset").show();
                    $(".answer-wrapper").show();
                    $("#directory_ask_question").addClass("disabled"); // disable button
                    if (window.ai_mode == "normal") {
                        directory_ask_question(question);
                    } else {
                        if (window.ai_mode == "search_once")
                            window.ai_mode = "normal";
                        // get search tokens
                        window.search_tokens = $("#directory_ask_question").closest(".directory_chat_wrapper").find("#question").val();
                        $("#directory_ask_question").closest(".directory_chat_wrapper").find("#question").val("");
                        update_chat(window.search_tokens, "end-user");
                        update_chat("<div class=\"lds-ellipsis\"><div></div><div></div><div></div><div></div></div></div>", "ai-not-typed", 1); //In Progress
                        partner_search_command(false, function(){ update_chat("Here are your results. Can I help you further?", "ai") });
                    }
                }else{
                    clear_initial_screen(); //reset ui if we are in the initial screen
                    //if we triggered an ai request from the temporary prompt adjust toggles.
                    if($("#directory_ai_search").length > 0){
                        //we have a toggle so use that
                        if($("#directory_ai_search").css("display") != "none"){
                            $("#directory_ai_search").trigger("click");
                        }
                    }else{
                        clear_initial_screen(); //reset ui if we are in the initial screen
                        //if we triggered an ai request from the temporary prompt adjust toggles.
                        if($("#directory_ai_search").length > 0){
                            //we have a toggle so use that
                            if($("#directory_ai_search").css("display") != "none"){
                                $("#directory_ai_search").trigger("click");
                            }
                        }else{
                            //we only have ai in the nav area so only display that.
                            $("#partner_block_wrapper").hide();
                            $(".ai_partner_block_wrapper").show();
                            $("#directory_filters").hide();
                            $("#directory_notices").hide();
                            if($("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").length != 0){
                                $("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                            }
                            $(".directory_feature_listing_wrapper").hide();
                            $("#directory_sidebar_wrapper .directory_chat_wrapper").show();
                            $("#home_directory_search_modal").addClass("ai_enabled");
                            $("#directory_nav_wrapper > .directory_ul_nav_wrapper").hide();
                            window.cmx_prevent_load_on_scroll = 1;
                            update_chat("You must type a question.", "ai");
                        }
                    }
                    update_chat("You must type a question.", "ai");
                }
            }

            $(document).on("click", "#directory_ask_question", function(event){
                if(!$(this).hasClass("disabled")){
                    $("#items_block_result_output").hide().html("");
                    $("#account_block_result_output").hide().html("");
                    $("#items_block_result_wrapper .notices").html("").hide();
                    $("#account_block_result_wrapper .notices").html("").hide();
                    $(".ai_partner_block_wrapper").html("").hide();
                    $("#ai_account_notices").html("").hide();  
                    var ai_this = $(this).closest(".ai-question-field-wrapper").find("#question").val();
                    ai_initiate_question(ai_this);
                }
            });
            function validate_ai_question(msg_val){
                if(msg_val != ""){
                    return true;
                }
                return false;
            }

            window.cmx_chat_bubble_id = 0;
            window.ai_chat_queue = [];
            window.ai_chat_in_progress = 0;

            function update_chat(message, user_type, tag_for_removal = 0, outer_box_addon = "" ){
                $("#answer").show();

                if(message == undefined || message == ""){
                    return "";
                }
                if(window.ai_chat_in_progress == 1 && (user_type == "ai-not-typed" || user_type == "ai" || user_type == "flush")){
                    //ai chat with blocker
                    add_to_ai_chat_queue(message, user_type, tag_for_removal, outer_box_addon);
                }else{
                    //user chat
                    if((user_type == "ai-not-typed" || user_type == "ai" || user_type == "flush")){
                        $(".talk-bubble.remove").remove();
                        window.ai_chat_in_progress = 1;
                    }
                    if (user_type == "flush") {
                        ai_chat_callback();
                    } else {
                        var user_type_class = (user_type == "ai-not-typed") ? "ai" : user_type;
                        if(tag_for_removal == 1){
                            user_type_class = user_type_class+" remove";
                        }
                        var output = "<div class=\"talk-bubble "+user_type_class+" id_"+window.cmx_chat_bubble_id+"\">";
                        output += "<div class=\"talktext\">";
                        if(user_type != "ai"){
                            output += message;
                        }
                        output += "</div>";
                        if (outer_box_addon != "")
                            output += "<div class=\"outerbox-addon\" style=\"display:flex; justify-content: flex-end;\">"+outer_box_addon+"</div>";
                        output += "</div>";
                        $(".answer-wrapper #answer").append(output);
                        if(user_type == "ai-not-typed"){
                            window.ai_chat_in_progress = 0;
                            window.cmx_chat_bubble_id++;
                            ai_chat_callback();
                        }
                        if(user_type == "ai"){
                            $multiple_messages = message.split("== new chat ==");
                            if($multiple_messages.length == 1){
                                $(".answer-wrapper #answer .id_"+window.cmx_chat_bubble_id+" .talktext").outputWordsWithDelay(message.replace(/\n/g, "<br>"), { outputPartDelay: 40, completedCallBack: function () { window.cmx_chat_bubble_id++; window.ai_chat_in_progress = 0; ai_chat_callback(); } });
                            }else{
                                $(".answer-wrapper #answer .id_"+window.cmx_chat_bubble_id+" .talktext").outputWordsWithDelay($multiple_messages[0].replace(/\n/g, "<br>"), { outputPartDelay: 40, completedCallBack: function () { window.cmx_chat_bubble_id++; window.ai_chat_in_progress = 0;  ai_chat_callback(); } });
                                window.cmx_chat_bubble_id++;
                                for (var i = 0; i < $multiple_messages.length; i++) {
                                    if(i != 0){
                                        add_to_ai_chat_queue($multiple_messages[i], user_type, tag_for_removal, outer_box_addon);
                                    }
                                }
                            }
                        }else{
                            if(window.ai_chat_queue.length == 0){
                                answer_chat_scroll_to();
                            }
                        }
                    }
                }
                if(user_type == "end-user"){
                    answer_chat_scroll_to();
                }
            }


            function add_to_ai_chat_queue(message, message_type, tag_for_removal, outer_box_addon){
                window.ai_chat_queue.push([message, message_type, tag_for_removal, outer_box_addon]);
            }

            function ai_chat_callback(){
                window.ai_chat_in_progress = 0;
                if(window.ai_chat_queue.length > 0){
                    var next_ai_chat = window.ai_chat_queue.shift();
                    update_chat(next_ai_chat[0], next_ai_chat[1], next_ai_chat[2], next_ai_chat[3]);
                }
            }

            function answer_chat_scroll_to(){
                $(".answer-wrapper #answer").animate({scrollTop: $(".answer-wrapper #answer").get(0).scrollHeight}, 1000);
            }

            function directory_ask_question(msg_val) {
                clear_initial_screen(); //reset ui if we are in the initial screen
                //if we triggered an ai request from the temporary prompt adjust toggles.
                if($("#directory_ai_search").length > 0){
                    if($("#directory_ai_search").find(".glyphicon").hasClass("glyphicon-chevron-right")){
                        $("#directory_ai_search").trigger("click");
                    }
                }else{
                    $("#partner_block_wrapper").hide();
                    $(".ai_partner_block_wrapper").show();
                    $("#directory_filters").hide();
                    $("#directory_notices").hide();
                    if($("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").length != 0){
                        $("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                    }
                    $("#items_block_result_wrapper .notices, #account_block_result_wrapper .notices").hide();
                    $(".directory_feature_listing_wrapper").hide();
                    $("#directory_sidebar_wrapper .directory_chat_wrapper").show();
                    $("#home_directory_search_modal").addClass("ai_enabled");
                    $(".directory_ul_nav_wrapper").hide();
                    window.cmx_prevent_load_on_scroll = 1;
                }
                window.directory_ai_run_id = "";
                window.directory_ai_run_cnt = 5;
        
                // create a thread
                var formData = new FormData();
                $("#question").val(""); // clear question field
                update_chat(msg_val, "end-user");
                update_chat("<div class=\"lds-ellipsis\"><div></div><div></div><div></div><div></div></div></div>", "ai-not-typed", 1); //In Progress
                $("#ai_account_notices").html("");
                //$(".ai_partner_block_wrapper").show().html("<div id=\"ai_loader\">Gathering Recommendations <div class=\"lds-ellipsis\"><div></div><div></div><div></div><div></div></div></div>");// set ai loading spinner
                formData.append("command", "create_message");
                formData.append("tid", window.directory_ai_thread_id);
                formData.append("cid", window.directory_ai_conversation_id);
                formData.append("msg", msg_val);
                formData.append("aid", "asst_tlbfvAAzZJy4YVQripUH6aFm");
                formData.append("pa_id", "13818");
                formData.append("mid", window.known_member_id);
                formData.append("curl", removeParam("ss", removeParam("cc", window.location.href)));
                window.directory_ai_messages_processed = 0;
                window.current_ai_request = $.ajax({
                    "url": "https://contentmx.com/b/ai_assistant_commands.php",
                    "type": "post",
                    "data": formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (response) {
                        if (response.error == "") {
                            if("cid" in response){
                               window.directory_ai_conversation_id = response.cid;
                            }
                            if("tid" in response){
                                window.directory_ai_thread_id = response.tid;
                            }
                            // now ask to get answer
                            var formData = new FormData();
                            formData.append("command", "create_run");
                            formData.append("tid", window.directory_ai_thread_id);
                            formData.append("cid", window.directory_ai_conversation_id);
                            formData.append("aid", "asst_tlbfvAAzZJy4YVQripUH6aFm");
                            formData.append("mid", window.known_member_id);
                            window.current_ai_request = $.ajax({
                                "url": "https://contentmx.com/b/ai_assistant_commands.php",
                                "type": "post",
                                "data": formData,
                                processData: false,
                                contentType: false,
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (response) {
                                    if (response.error == "") {
                                        window.directory_ai_run_id = response.rid;
                                        setTimeout(() => {
                                            directory_wait_for_answer(180, 1000); // 3 minutes at 1 second intervals
                                        }, "1000");                   
                                    } else {
                                        if (!showing_ai_conversation) {
                                            $("#directory_ask_question").removeClass("disabled");
                                        }
                                        console.log("Create run failed: " + response.error);
                                        window.ai_mode = "search_once";
                                        clear_initial_screen();
                                        update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                                        $("#ai_loader").remove();
                                    }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    if (!showing_ai_conversation) {
                                        $("#directory_ask_question").removeClass("disabled");
                                    }
                                    console.log("Create run failed: " + textStatus);
                                    window.ai_mode = "search_once";
                                    clear_initial_screen();
                                    update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                                    $("#ai_loader").remove();
                                }
                            });
                        } else {
                            if (!showing_ai_conversation) {
                                $("#directory_ask_question").removeClass("disabled");
                            }
                            console.log("Create message failed: " + response.error);
                            window.ai_mode = "search_once";
                            clear_initial_screen();
                            update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                            $("#ai_loader").remove();
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (!showing_ai_conversation) {
                            $("#directory_ask_question").removeClass("disabled");
                        }
                        console.log("Create message failed: " + textStatus);
                        window.ai_mode = "search_once";
                        clear_initial_screen();
                        update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                        $("#ai_loader").remove();
                    }
                });
            }
 
            function directory_wait_for_answer(max_times, wait) {
                if (max_times > 1 && window.directory_ai_thread_id != "") {
                    // wait = wait * 2;
                    if(typeof window.prevent_check_run_partner_directory !== "undefined"){
                        if(window.prevent_check_run_partner_directory == 1){
                            window.prevent_check_run_partner_directory = 0;
                            return "";
                        }
                        window.prevent_check_run_partner_directory = 0;
                    }
                    var formData = new FormData();
                    formData.append("command", "check_run_partner_directory");
                    formData.append("tid", window.directory_ai_thread_id);
                    formData.append("cid", window.directory_ai_conversation_id);
                    formData.append("rid", window.directory_ai_run_id);
                    formData.append("aid", "asst_tlbfvAAzZJy4YVQripUH6aFm");
                    formData.append("pa_id", "13818");
                    formData.append("mid", window.known_member_id);
                    formData.append("msg_proc", window.directory_ai_messages_processed);
                    window.current_check_run_partner_directory = $.ajax({
                        "url": "https://contentmx.com/b/ai_assistant_commands.php",
                        "type": "post",
                        "data": formData,
                        processData: false,
                        contentType: false,
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (response) {
                            if (response.error == "") {
                                if (response.status == "in_progress") {
                                    window.directory_ai_messages_processed = response.messages_processed;
                                    if (response.non_json_advice != "" && response.non_json_advice != undefined) {
                                        update_chat(response.non_json_advice, "ai");
                                        update_chat("<div class=\"lds-ellipsis\"><div></div><div></div><div></div><div></div></div></div>", "ai-not-typed", 1); //In Progress
                                    }
                                    setTimeout(() => {
                                        directory_wait_for_answer(max_times - 1, wait);
                                    }, wait);
                                } else if (response.status == "queued") {
                                    setTimeout(() => {
                                        directory_wait_for_answer(max_times - 1, wait);
                                    }, wait);
                                } else if (response.status == "retry") {
                                    window.directory_ai_run_id = response.rid;
                                    var max_tries = 120;
                                    if (window.directory_ai_run_cnt > 1) {
                                        window.directory_ai_run_cnt = window.directory_ai_run_cnt - 1;
                                        max_tries = 60;
                                    } else {
                                        max_tries = 0;
                                    }
                                    setTimeout(() => {
                                        directory_wait_for_answer(max_tries, 1000); // 3 minutes at 1 second intervals
                                    }, wait);
                                } else {
                                    if ("search_session_id" in response) {
                                        window.search_session_id = response.search_session_id;
                                        window.sub_session_id = 0;
                                    }

                                    $("#directory_whimsy").hide();

                                    window.naids = ('naids' in response) ? response.naids : [];
                                    window.niids = ('niids' in response) ? response.niids : [];
                                    if (!showing_ai_conversation) {
                                        $("#directory_ask_question").removeClass("disabled");
                                    }
                                    if (response.output == "") {
                                        $(".ai_partner_block_wrapper").show().html("");
                                    } else {
                                        $("#partner_directory_wrapper.ai_enabled").removeClass("wide_initial_ai_width");
                                        $(".ai_partner_block_wrapper").show().html(response.output);
                                        $(".ai_partner_block_wrapper .partner_block").each(function(){
                                            $(this).fadeIn(3000);
                                        });
                                    }
                                    //output items to item output wrapper
                                    if($("#items_block_result_wrapper").length > 0){
                                        if (typeof directory_items_listings_render === "function"){
                                            if($(".show_search_on_home_page").length > 0){
                                                //partner case 
                                                if(typeof(response) == "undefined" || typeof(response.items) == "undefined" || ("items" in response && response.items.length == 0) ){
                                                    var full_count = 0;
                                                    if("full_items_count" in response ){
                                                        full_count = response.full_items_count;
                                                    }
                                                    //no items returned
                                                    if(
                                                        ("search_tokens" in response === true && 
                                                        Array.isArray(response.search_tokens) && 
                                                        response.search_tokens.length == 0)
                                                         ||
                                                        ("search_tokens" in response === false)
                                                    ){ 
                                                        //no tokens returned no items
                                                        directory_render_whimsy("no_tokens_encouragement", full_count);
                                                    }else if(
                                                        "search_tokens" in response && 
                                                        Array.isArray(response.search_tokens) && 
                                                        response.search_tokens.length > 0
                                                    ){
                                                        //tokens returned no items
                                                        directory_render_whimsy("tokens_encouragement", full_count);
                                                    }
                                                }else{
                                                    directory_items_listings_render(response);
                                                }
                                            }else{
                                                //dir case
                                                if(
                                                    (typeof(response) == "undefined" || typeof(response.items) == "undefined" || ("items" in response && response.items.length == 0)) &&
                                                    (typeof(response) == "undefined" || typeof(response.accounts) == "undefined" || ("items" in response && response.accounts.length == 0))
                                                ){
                                                    if(
                                                        ("search_tokens" in response 
                                                        && Array.isArray(response.search_tokens)
                                                        && response.search_tokens.length == 0) ||
                                                        "search_tokens" in response === false
                                                    ){ 
                                                        //no tokens returned no items
                                                        directory_render_whimsy("no_tokens_encouragement", 0);
                                                    }else if(
                                                        "search_tokens" in response 
                                                        && Array.isArray(response.search_tokens)
                                                        && response.search_tokens.length > 0
                                                    ){
                                                        //tokens returned no items
                                                        directory_render_whimsy("tokens_encouragement", 0);
                                                    }
                                                }else{
                                                    directory_items_listings_render(response);
                                                }
                                            }
                                        }
                                    }
                                    
                                    var results_icon = "";
                                    if (
                                        (response.output != "" || ("items" in response && response.items.length > 0))
                                        && 'search_tokens' in response 
                                        && Array.isArray(response.search_tokens)
                                        && response.search_tokens.length > 0
                                    ) {
                                        // also if the session id is there
                                        // add a message to click on to see these results in the future as well
                                        if ('search_session_id' in response) {
                                            results_icon = "<a href=\"#\" id=\"search_view\" data-ssid=\""+response.search_session_id+"\" title=\"Click here to replay these results\"><span class=\"glyphicon glyphicon-list-alt\"></span></a>"; 
                                            if (response.non_json_advice == "")
                                                response.non_json_advice = "Here are your results!"
                                        }
                                    }
                                    
                                    if (response.non_json_advice != "") {
                                        update_chat(response.non_json_advice, "ai", 0, results_icon);
                                    } else {
                                        update_chat("dummy message", "flush");
                                    }
                                    /*
                                    if (
                                        (response.output != "" || ("items" in response && response.items.length > 0))
                                        && 'search_tokens' in response 
                                        && Array.isArray(response.search_tokens)
                                        && response.search_tokens.length > 0
                                    ) {
                                        // we are returning data
                                        // so ask if they want a direct search
                                        var quoted_tokens = response.search_tokens.map(function(value){
                                            return '"'+value+'"';
                                        });
                                        window.search_tokens = quoted_tokens.join(" ");                                    
                                        var msg = "Click <a href=\"#\" id=\"search_tokens\">here</a> to perform a further search on ";
                                        // #$#$#$# <== search for this to find the other place we combine tokens
                                        // this needs to be consistent with search tokens in ai_assistant_commands.php
                                        msg += [quoted_tokens.slice(0, -1).join(', '), quoted_tokens.slice(-1)[0]].join(quoted_tokens.length < 2 ? '' : ' and ');
                                        msg += ".";
                                        update_chat(msg, "ai-not-typed");
                                    }
                                    */
                                }
                            } else {
                                if (!showing_ai_conversation) {
                                    $("#directory_ask_question").removeClass("disabled");
                                }
                                //add whimsy 
                                directory_render_whimsy("no_results");
                                console.log("Wait for response failed: " + response.error);
                                window.ai_mode = "search_once";
                                clear_initial_screen();
                                update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                                $("#ai_loader").remove(); 
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            if (!showing_ai_conversation) {
                                $("#directory_ask_question").removeClass("disabled");
                            }
                            console.log("Wait for response failed: " + textStatus);
                            window.ai_mode = "search_once";
                            clear_initial_screen();
                            update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai-not-typed");
                            $("#ai_loader").remove();
                        }
                    });
                } else {
                    if (!showing_ai_conversation) {
                        $("#directory_ask_question").removeClass("disabled");
                    }
                    console.log("Wait for answer timed out");
                    window.ai_mode = "search_once";
                    clear_initial_screen();
                    update_chat("Our AI functions seem a bit busy or ill at the moment, please enter a few keywords of what you might be looking for in the box below and I will go directly to the data to find results with all of those keywords. You can always use the word - or - if you want some keywords to be optional.", "ai", 1);
                    $("#ai_loader").remove();
                }
            }
            
            $(document).on("click", "#search_view", function(event){
                var ssid = $(this).data("ssid");
                $("#directory_whimsy").hide();
                var formData = new FormData();
                formData.append("command", "get_search_results");
                formData.append("ssid", ssid);
                formData.append("pa_id", "13818");
                $.ajax({
                    "url": "https://contentmx.com/b/ai_assistant_commands.php",
                    "type": "post",
                    "data": formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (response) {
                        window.search_session_id = ssid;
                        window.sub_session_id = 0;
                        
                        // clear the directory results first
                        $("#items_block_result_output").html("");
                        $("#account_block_result_output").html("");
                        $("#items_block_result_wrapper .notices").html("").hide();
                        $("#account_block_result_wrapper .notices").html("").hide();
                        $(".ai_partner_block_wrapper").hide().html("");
                        $("#ai_account_notices").html("").hide();
                        
                        if (response.accounts == "") {
                            $(".ai_partner_block_wrapper").show().html("");
                        } else {
                            $("#partner_directory_wrapper.ai_enabled").removeClass("wide_initial_ai_width");
                            $(".ai_partner_block_wrapper").show().html(response.accounts);
                            $(".ai_partner_block_wrapper .partner_block").each(function(){
                                $(this).fadeIn(3000);
                            });
                        }
                        //output items to item output wrapper
                        if($("#items_block_result_wrapper").length > 0){
                            if (typeof directory_items_listings_render === "function"){
                                directory_items_listings_render(response);
                            }
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("Wait for response failed: " + textStatus);
                    }
                });
            });

            $(document).on("click", "#search_tokens", function(event){
                partner_search_command(false);
            });

            //on click View Link Button
            $(document).on("click", ".partner_block_link", function(event) {
                var pspcu = "https://contentmx.com/b/page_commands.php";
                var vaid = $(this).data("vaid");
                var ssid = window.sub_search_session_id > 0 ? window.sub_search_session_id : window.search_session_id;
                $.get(pspcu+"?command=page_activity&type=directory_partner_view&vaid="+vaid+"&m="+window.known_member_id+"&aid="+13818+"&ssid="+ssid);
            });

            //ai on load init
            var showing_ai_conversation = false;
            directory_create_chat(); 
            window.directory_ai_thread_id = "";
            window.directory_ai_conversation_id = "";
            //init_ai_search(); //ktg
            window.ai_mode = "normal";
            $(".directory_feature_listing_wrapper").hide();
            $(".partner_block_wrapper").hide();
            window.cmx_prevent_load_on_scroll = 1;
             
    });

 
</script>

    <div id="partner_directory_wrapper" class="ai_enabled show_search_on_home_page ">
            
            <div id="directory_sidebar_wrapper">
                <div id="directory_nav_wrapper"><div class="directory_filter_toggle"><div id="directory_filter_search"><span class="radio_circle"></span> Let's Search</div><div id="directory_ai_search"><span class="radio_circle"></span> Let's Chat</div></div>
        <div class="search-col">
            <div class="partner-search">
                <div class="search-col-inner"><input type="text" class="form-control" id="partner-search-string" name="partner-search-string" autocomplete="off" value="" size="30" maxlength="200" placeholder="What are you looking for?"><span id="clear_directory_search" style="display:none;" class="glyphicon glyphicon-remove" aria-hidden="true"></span></div><button id="home_directory_search_button">Search</button><input type="text" class="form-control" id="home_directory_ask_question_field" name="home_directory_ask_question_field" autocomplete="off" value="" size="30" maxlength="200" style="display:none;" placeholder="Let's Chat. How can I help?"><button type="button" style="display:none;" class="btn btn-primary" id="home_directory_ask_question"><span class="glyphicon glyphicon-circle-arrow-up" aria-hidden="true"></span></button>
            </div>
        </div>
        <script>
			document.addEventListener("DOMContentLoaded", () => {
				$("#partner-search-string").val("");
			});
        </script>
    </div></div>
    </div>
    
        <style>
        .ui-dialog { 
            z-index: 1000 !important;
        }
        .search_nav_wrapper,
        .conversation_nav_wrapper {
        }
        .search_table,
        .conversation_table {
            display: table;
            width: 100%;
        }
        .search_row,
        .conversation_row {
            display: table-row;
        }
        .search_header,
        .conversation_header {
            border-bottom: 1px solid #888;
            background: #DDDDDD;
        }
        .search_col,
        .conversation_col {
            display: table-cell;
            vertical-align: baseline;
            padding:10px;
            border-top: 1px solid #ddd;
        }
        .search_button,
        .conversation_button {
            padding-right: 5px;
            cursor: pointer;
        }
        .search_description_edit_buttons,
        .coversation_description_edit_buttons {
            padding-top: 5px;
        }
        .search_table_filter,
        .conversation_table_filter {
            padding-bottom: 5px;
        }
        </style>
    
							</div>
						</div>
						
						<div class="content-col branding-col">
															<div class="actions">
																<a class="action btn btn-primary" href="https://bubblecloud.lll-ll.com?page&i=4165457">Request More Information</a>
																																								</div>
													</div>

					</div>
			</div>
		</header>
	</div>
		
	
			<div id="home_directory_search_modal" class="full_width" style="display:none;"><div id="home_directory_search_nav">
            <div class="directory_chat_wrapper">
                <div class="directory_chat_wrapper_inner">
                    <div class="ai_close_wrapper"><span class="ai_close_button glyphicon glyphicon-remove" aria-hidden="true"></span></div>
                    <div id="directory_ai_thread">Initializing</div>
                </div>
            </div></div>
<div id="directory_content_wrapper">
    <div class="item_block_wrapper">
        <div id="items_block_result_wrapper">
            <div class="notices alert alert-info" style="width:100%; text-align: center; display:none; min-height:55px;"></div>
            <div id="items_block_result_output"></div>
            <div id="load_more"><span class="load_more_loading" style="display:none; font-weight: bold; font-size: 20px; align-items: center; justify-content: center;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:block;" width="80px" height="80px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
        <g transform="rotate(0 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(30 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(60 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(90 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(120 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(150 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(180 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(210 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(240 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(270 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(300 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"></animate>
          </rect>
        </g><g transform="rotate(330 50 50)">
          <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#0b0b0b">
            <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="0s" repeatCount="indefinite"></animate>
          </rect>
        </g>
        </svg> Loading</span></div>
        </div>
        
    </div>
</div></div>
	
									<link type="text/css" href="https://contentmx.com/p/templates/microsite-vendor/stylesheets/fontawesome-6-4-0-web/css/regular.min.css" rel="stylesheet" />
			<div class="posts post-archive">
				<div class="post-single site-width">
					<article class="post">

					
																													
												
																	<h2>
									Set Your Document Free
									</h2>
								
																									
																	
							

							<div class="body-post detail-content-block">
									
																					<p>This eBook discusses the challenges faced by organizations in extracting and analyzing data from documents. It also highlights the benefits of using intelligent document processing (IDP) powered by machine learning (ML) to overcome these challenges.</p>
										
																</div>


							<div class="item-toolbar">
																	<div class="pdf-download detail-content-block">
											<a href="https://fe5e0932bbdbee188a67-ade54de1bba9a4fe61c120942a09245b.ssl.cf1.rackcdn.com/Set-your-document-free_AWS_Pub_Sector.pdf" title="Download this Asset"  class="btn btn-primary" target="_blank">Download</a>
									</div>
								
								<div class="share-post">
									<ul>
										<li class="facebook"><a target="_blank" title="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fbubblecloud.lll-ll.com%3Fpage%26i=3956871"><i class="fa-brands fa-facebook"></i></a></li>
										<li class="twitter"><a target="_blank" title="Share on Twitter (X)" href="https://twitter.com/share?text=Set%20Your%20Document%20Free&url=https%3A%2F%2Fbubblecloud.lll-ll.com%3Fpage%26i=3956871"><i class="fa-brands fa-twitter"></i></a></li>
										<li class="linkedin"><a target="_blank" title="Share on LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fcontentmx.com%2Fb%2Fpage%2Fpage.php%3Fu%3Drbishop007%26i%3D3956871&title=Set%20Your%20Document%20Free&summary=Unlock%20the%20power%20of%20your%20documents%20with%20%40AWSCloud%20machine%20learning%20services.%20Extract%20data%20and%20understand%20sentiment%20with%20Amazon%20Textract%2C%20Comprehend%2C%20and%20A2I.%20Contact%20Bubble%20Cloud%2F%20Bubble%20Social%20Media%20Marketing%20today%20for%20info."><i class="fa-brands fa-linkedin"></i></a></li>
										<li class="email"><a target="_blank" title="Share via Email" href="mailto:?subject=Set%20Your%20Document%20Free&body=LINK:%20https%3A%2F%2Fbubblecloud.lll-ll.com%3Fpage%26i=3956871"><i class="fa-solid fa-envelope"></i></a></li>
																				<li class="favorite"><span class="glyphicon glyphicon-heart-empty cmx-bookmark" bm="" ot="1" oid="3956159"></span></li>
									</ul>
								</div> 
							</div>

							
																																	<div class="display-pdf">
										<iframe width="100%" height="900" src="https://fe5e0932bbdbee188a67-ade54de1bba9a4fe61c120942a09245b.ssl.cf1.rackcdn.com/Set-your-document-free_AWS_Pub_Sector.pdf" scrolling="no"></iframe>
									</div>
															
						
						
					</article>
				</div>
			</div>
				<!-- Go Top -->
	<a class="go-top">
		<i class="fa-solid fa-chevron-up"></i>
	</a>
			<script type="text/javascript" src="https://contentmx.com/p/templates/microsite-vendor-library/javascript/iframeResizer/iframeResizer.min.js"></script>	
		
		<script type="text/javascript">
			$('.post-single iframe').iFrameResize({log:false});
		</script>
		
				<div id="footer-wrapper">
    <div class="footer-content-wrapper site-width">
        <div class="footer-content left">
            <div class="nav-wrap">
                <nav id="footernav" class="footernav">
                    <ul class="menu">
                                                <li><a href="https://bubblecloud.lll-ll.com?page">Home</a></li>
                                                                            <li>
                                <a href="https://www.bubblesocialmediamarketing.com" target="_blank">Contact Us</a>
                            </li>
                                                                            <li>
                                <a href="https://outlook.office.com/bookwithme/user/4e62182a261848ad90da51b5bcf95cd8@bubblesocialmediamarketing.com/meetingtype/TyqJVmOvyUOIknrX2i2vdw2?anonymous&ep=mlink" class="meet-me-button" target="_blank">Schedule a Meeting</a>
                            </li>
                                                <li>
		<a href="#" id="fair-use-bttn">Fair Use</a>
		<div id="fair-use-content" style="display:none;">
		The material on this site is provided for educational and informational purposes. All photos that haven't been taken by us have either been purchased, used with permission, credited and linked back to their original sources or believed to be public domain.  It is believed that this constitutes a &#x60;fair use&#x60; of any such copyrighted material as provided for in section 107 of the US Copyright Law. In accordance with Title 17 U.S.C. Section 107, the material on this site is distributed without profit to those who have an interest in using the included information for research and educational purposes. If you wish to use copyrighted material from this site for purposes of your own that go beyond &#x60;fair use&#x60;, you must obtain permission from the copyright owner.
		</div>
		<script>
			$(document).on("click","#fair-use-bttn",function(e) {
				e.preventDefault();
				window.fair_use_dialog = $(document.createElement("div")); 
				window.fair_use_dialog.dialog({autoOpen: false, modal: true, dialogClass:"fairuse-modal", bgiframe: true, width:900, close: function(event, ui){$(this).dialog('destroy'); window.fair_use_dialog = '';}});
				window.fair_use_dialog.dialog("option", "title", "Fair Use");
				window.fair_use_dialog.dialog("open");
				var fair_use_html = $("#fair-use-content").html();
				$(window.fair_use_dialog).html(fair_use_html);
			});

		</script>
		<style>.fairuse-modal .ui-dialog-content{padding:20px;}</style>
		</li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="footer-content right">
                        <div class="social-connect contact-items">
                                <a class="facebook social-connect-item fa-brands fa-facebook" href="https://www.facebook.com/bubblesocialmediamarketing/" target="_blank"></a>
                                                <a class="twitter social-connect-item fa-brands fa-twitter" href="https://twitter.com/BubbleSocialMed" target="_blank"></a>
                                                                <a class="linkedin social-connect-item fa-brands fa-linkedin" href="https://www.linkedin.com/company/bubble-social-media-marketing" target="_blank"></a>
                                            </div>
                    </div>
    </div>
</div>
<script>

$( document ).ready(function() {

    function adjust_sticky_header_on_load(){
        //onload are we mobile?
        var is_mobile = window.matchMedia("only screen and (max-width: 680px)").matches;
        if(is_mobile){
            $('#fixed-header-wrapper').css({"position":"relative"});
            $('body').css({"margin":"0"});
        }else{
            $('#fixed-header-wrapper').css({"position":""});
            $('body').css({"margin":""});
        }
    }

    adjust_sticky_header_on_load();

    $(window).on('resize', function(){
        adjust_sticky_header_on_load();
    });

    $(window).on("scroll touchmove", function () {
        var is_mobile = window.matchMedia("only screen and (max-width: 680px)").matches;
        if(!is_mobile){
            $('body').css({"margin":""});
            if($(document).scrollTop() > 256){
                $('.partner_directory_menu_bar').css({"height":"0", "overflow":"hidden"});
                $('.branding-company-name.info-row .profile-org-name').css({"font-size":"16px"});
                $('.logo-col').css({"padding-bottom":"0"});
                $('header').css({"padding-top":"10px","padding-bottom":"10px"});
            }else{
                $('.partner_directory_menu_bar').css({"height":"", "overflow":""});
                $('.branding-company-name.info-row .profile-org-name').css({"font-size":""});
                $('.logo-col').css({"padding-bottom":""});
                $('header').css({"padding-top":"","padding-bottom":""});
            }
        }else{
            $('.partner_directory_menu_bar').css({"height":"", "overflow":""});
            $('.branding-company-name.info-row .profile-org-name').css({"font-size":""});
            $('.logo-col').css({"padding-bottom":""});
            $('header').css({"padding-top":"","padding-bottom":""});
            $('#fixed-header-wrapper').css({"position":"relative"});
            $('body').css({"margin":"0"});
        }
    });

        });

</script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeECR8kAAAAALN-pFES3fcUsvG_3fAUVnmVaU8B"></script>
	<script>window.plyr_setup_page_command_url="https://contentmx.com/b/page/../page_commands.php"</script><script type="text/javascript" src="https://contentmx.com/b/page/../lib/js/plyr/plyr.polyfilled.js?v=12.9"></script><script type="text/javascript" src="https://contentmx.com/b/page/../js/plyr_setup.js?v=12.9"></script><link type="text/css" href="https://contentmx.com/b/page/../lib/js/plyr/plyr.css?v=12.9" rel="stylesheet">
			<script type="text/javascript">
			$(document).ready(function(){
				search_and_setup_plyr_player($(document),'','multiple');	
			});
			</script>


		<script>
			function set_bookmark_login_message(){
				var message = "";
				message += "<h1 style=\"margin-top: 0px;\">The full experience is only one step away!</h1><br>";
				message += "You must login to use this feature.<br>";
				message += "<br>Sign in to unlock valuable content and features from our AI-driven platform. Receive timely technology updates and the latest information from the solution providers who can help you realize your goals.<br>"; 
				return message;
			}
			function get_bm_url(item){
				var dir_conf = "";
				var url = "";
				if(item.dir_conf != "" && item.dir_conf != "[]"){
					dir_conf = JSON.parse(item.dir_conf);
				}
				if(dir_conf != "" && ("directory_slug" in dir_conf && "domain" in dir_conf) && dir_conf.domain != "" && dir_conf.directory_slug != ""){
					url = "https://"+dir_conf.domain+"/"+dir_conf.directory_slug+"/"+item.account_label;
				}else{
					url = "https://"+item.account_label+".lll-ll.com";
				}
					return url;
			}

			function generate_bm_item_acct_block(item){
				var item_bm = "";

				if(item.object_type == 2){
					item.url = get_bm_url(item);
				}

				item_bm += "<div class=\"bookmark-object bm\" bmid=\""+item.bookmark_id+"\" oid=\""+item.object_id+"\" ot=\""+item.object_type+"\" pad=\""+item.page_account_id+"\" t=\""+item.url+"\" u=\""+item.url+"\">";
				item_bm += "<div class=\"bookmark-object-border\">";
					item_bm += "<span class=\"glyphicon glyphicon-remove remove-bookmark\"></span>";
					bm_image = item.thumbnail_url;
					if(item.media_fb_thumb_url != ""){
						bm_image = item.media_fb_thumb_url;
					}
					item_bm += "<a class=\"partner_block_link\" target=\"_blank\" href=\""+item.url+"\"  class=\"bookmark-object\" style=\"display:flex; flex-direction:column;\">";
					item_bm += "<div class=\"bookmark-image\" style=\"background-image:url('"+bm_image+"');\"></div>";
					item_bm += "<div class=\"partner_block_name\">"+item.object_title+"</div>";
					item.description = $.trim(item.description); // trim whitespace
					if(item.description.length > 100){
						item.description = $("<div/>").html(item.description).text(); //remove html tags
						item.description = item.description.substring(0,100);
						item.description = item.description+"...";
					}
					item_bm += "<div class=\"partner_block_about\">"+$.trim(item.description)+"</div>";
					if(item.object_type == 1){
						item_bm += "<p class=\"item-company\">"+item.meta+"</p>";
					}
					item_bm += "</a>";
				item_bm += "</div>";
				item_bm += "</div>";

				return item_bm;
			}
			function generate_bm_search_block(item){
				//console.log(item);
				var item_bm = "";
				item_bm += "<div class=\"search_row search_data_row bm\" ot=\""+item.object_type+"\" bmid=\""+item.bookmark_id+"\" oid=\""+item.object_id+"\">";
					item_bm += "<div class=\"search_col\">";
						item_bm += "<a href=\""+item.url+"\">"+item.meta+"</a>";
					item_bm += "</div>";
					item_bm += "<div class=\"search_col\">"+item.object_title+"</div>";
					item_bm += "<div class=\"search_col\">";
						item_bm += "<div id=\"search_description_display\">"+item.description+"</div>";
					item_bm += "</div>";
					item_bm += "<div class=\"search_col\">";
						item_bm += "<span class=\"search_button text-danger glyphicon glyphicon-remove remove-bookmark\"></span>";
					item_bm += "</div>";
				item_bm += "</div>";

				return item_bm;
			}
			function generate_bm_chat_block(item){
				//console.log(item);
				var item_bm = "";
				item_bm += "<div class=\"conversation_row conversation_data_row bm\" ot=\""+item.object_type+"\" bmid=\""+item.bookmark_id+"\" oid=\""+item.object_id+"\">";
					item_bm += "<div class=\"conversation_col\">";
					if(item.url.indexOf("?") === -1){
						item.url = item.url+"?cc="+item.object_id;
					}else{
						item.url = item.url+"&cc="+item.object_id;
					}
						item_bm += "<a href=\""+item.url+"\">"+item.object_title+"</a>";
					item_bm += "</div>";
					item_bm += "<div class=\"conversation_col\">";
						item_bm += "<div id=\"conversation_description_display\"></div>";
					item_bm += "</div>";
					item_bm += "<div class=\"conversation_col\">";
						item_bm += "<span class=\"conversation_button text-danger glyphicon glyphicon-remove remove-bookmark\"></span>";
					item_bm += "</div>";
				item_bm += "</div>";

				return item_bm;
			}
			function build_bookmark_ui(bookmarks){
			var search_bm = "";
			var chat_bm = "";
			var acct_bm = "";
			var item_bm = "";
			var bm_image = "";
				if(bookmarks.length > 0){
					bookmarks.forEach(function (item, index) {
						if(item.object_type == 1){
							item_bm += generate_bm_item_acct_block(item);
						}else if(item.object_type == 2){
							acct_bm += generate_bm_item_acct_block(item);
						}else if(item.object_type == 3){
							search_bm += generate_bm_search_block(item);
						}else if(item.object_type == 4){
							chat_bm += generate_bm_chat_block(item);
						}
					});

					var bookmark_html = "";
					var bookmark_tabs = "";
					var tabs_class = "";
					var tabs_display = "";
					if(item_bm != ""){
						//console.log(item_bm);
						tabs_class = "";
						tabs_display = "none";
						if(bookmark_tabs == ""){
							tabs_class = " active";
							tabs_display = "flex";
						}
						bookmark_tabs += "<div class=\"bookmark-tab"+tabs_class+"\" id=\"bookmark-items\">Content</div>";
						bookmark_html += "<div id=\"bookmark-items-wrapper\" class=\"bookmarks-content-wrapper\" style=\"display:"+tabs_display+";\">"+item_bm+"</div>";
					}
					if(acct_bm != ""){
						//console.log(acct_bm);
						tabs_class = "";
						tabs_display = "none";
						if(bookmark_tabs == ""){
							tabs_class = " active";
							tabs_display = "flex";
						}
						bookmark_tabs += "<div class=\"bookmark-tab"+tabs_class+"\" id=\"bookmark-account\">Partners</div>";
						bookmark_html += "<div id=\"bookmark-account-wrapper\" class=\"bookmarks-content-wrapper\" style=\"display:"+tabs_display+";\">"+acct_bm+"</div>";
					}
					if(search_bm != ""){
						//console.log(search_bm);
						tabs_class = "";
						tabs_display = "none";
						if(bookmark_tabs == ""){
							tabs_class = " active";
							tabs_display = "flex";
						}
						bookmark_tabs += "<div class=\"bookmark-tab"+tabs_class+"\" id=\"bookmark-search\">Search</div>";
						bookmark_header = "<div class=\"search_row search_header\"><div class=\"search_col\"><strong>Search</strong></div><div class=\"search_col\"><strong>Search String</strong></div><div class=\"search_col\"><strong>Description</strong></div><div class=\"search_col\">&nbsp;</div></div>";
						bookmark_html += "<div id=\"bookmark-search-wrapper\" class=\"bookmarks-content-wrapper\" style=\"display:"+tabs_display+";\"><div class=\"search_table\">"+bookmark_header+search_bm+"</div></div>";
					}
					if(chat_bm != ""){
						//console.log(chat_bm);
						tabs_class = "";
						tabs_display = "none";
						if(bookmark_tabs == ""){
							tabs_class = " active";
							tabs_display = "flex";
						}
						bookmark_header = "<div class=\"conversation_row conversation_header\"><div class=\"conversation_col\"><strong>Chat</strong></div><div class=\"conversation_col\"><strong>Description</strong></div><div class=\"conversation_col\">&nbsp;</div></div>"
						bookmark_tabs += "<div class=\"bookmark-tab"+tabs_class+"\" id=\"bookmark-chat\">Chat</div>";
						bookmark_html += "<div id=\"bookmark-chat-wrapper\" class=\"bookmarks-content-wrapper\" style=\"display:"+tabs_display+";\"><div class=\"conversation_table\">"+bookmark_header+chat_bm+"</div></div>";
					}
					if(bookmark_html != ""){
						bookmark_tabs = "<div class=\"bookmarks_tabs_wrapper\">"+bookmark_tabs+"</div>";
						bookmark_html = "<div class=\"bookmarks_wrapper\">"+bookmark_tabs+bookmark_html+"<div>";
						return bookmark_html;
					}else{
						return "<div class=\"\">You have no favorites to display at this time.</div>";
					}
				}else{
					return "<div class=\"\">You have no favorites to display at this time.</div>";
				}
			}

		    function create_bookmarks_popup() {
                var formData = new FormData();
                formData.append("command", "get_bookmarks");
                $.ajax({
                    "url": "https://contentmx.com/b/page_commands.php",
                    "type": "post",
                    "data": formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (response) {
						if(response.status == 0){
							//we had a failure alert user
							var title_html = set_bookmark_login_message();
							displayVisitorSignInDialog(title_html,"");
						}else if(response.status == 1){
							window.bookmarks_dialog = $(document.createElement("div")); 
							window.bookmarks_dialog.dialog({autoOpen: false, modal: true, dialogClass:"bookmarks-modal", bgiframe: true, width:900, close: function(event, ui){$(this).dialog('destroy'); window.search_history_dialog = '';}});
							window.bookmarks_dialog.dialog("option", "title", "Favorites");
							window.bookmarks_dialog.dialog("open");
							var bookmark_html = build_bookmark_ui(response.bookmarks);
							$(window.bookmarks_dialog).html(bookmark_html);
						}
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("Get searches failed: " + textStatus);
                    }
                });
            }

		    $(document).on("click", "#visitor-bookmarks", function(e){
                e.preventDefault();
                create_bookmarks_popup();
            });

		    $(document).on("click",".cmx-bookmark",function() {
				var current_this = $(this);
				var oid = $(this).attr("oid");
				var ot = $(this).attr("ot");
				var pai = "13818";
				var bm = $(this).attr("bm");
				$.ajax({
					type: "POST",
					url: "https://contentmx.com/b/page_commands.php",
					data: { "oid": oid, "ot": ot, "command":"bookmark","pai":pai,"bm":bm},
					success: function (data) {
						if(data.status == 0){
							//we had a failure alert user
							var title_html = set_bookmark_login_message();
							displayVisitorSignInDialog(title_html,"");
						}else if(data.status == 1){
							//bookmark added
							$(current_this).addClass("bookmarked").addClass("glyphicon-heart").removeClass("glyphicon-heart-empty");
							if("bm" in data){
								$(current_this).attr("bm", data.bm);
							}else{
								$(current_this).attr("bm", "");
							}
						}else if(data.status == 2){
							//bookmark removed
							$(current_this).removeClass("bookmarked").addClass("glyphicon-heart-empty").removeClass("glyphicon-heart");
							$(current_this).attr("bm", "");
						}
					},
					error: function (textStatus, errorThrown) {
						console.log(textStatus, errorThrown);
					}
				});
			});
			$(document).on("click",".bookmark-tab",function() {
				var id_val = $(this).attr("id");
				$(".bookmark-tab").removeClass("active");
				$(this).addClass("active");
				$(".bookmarks-content-wrapper").hide();
				if(id_val == "bookmark-items"){
					$("#bookmark-items-wrapper").css({"display":"flex"});
				}else if(id_val == "bookmark-account"){
					$("#bookmark-account-wrapper").css({"display":"flex"});
				}else if(id_val == "bookmark-search"){
					$("#bookmark-search-wrapper").css({"display":"flex"});
				}else if(id_val == "bookmark-chat"){
					$("#bookmark-chat-wrapper").css({"display":"flex"});
				}
			});
			$(document).on("click",".remove-bookmark",function() { 
				var current_this = $(this);
				var oid = $(this).closest(".bm").attr("oid");
				var ot = $(this).closest(".bm").attr("ot");
				var pai = "13818";
				var bm = $(this).closest(".bm").attr("bmid");
				$.ajax({
					type: "POST",
					url: "https://contentmx.com/b/page_commands.php",
					data: { "oid": oid, "ot": ot, "command":"bookmark-remove","pai":pai,"bm":bm},
					success: function (data) {
						if(data.status == 0){
							//we had a failure alert user
							var title_html = set_bookmark_login_message();
							displayVisitorSignInDialog(title_html,"");
						}else{
							//bookmark removed
							$(current_this).closest(".bm").remove();
						}
					},
					error: function (textStatus, errorThrown) {
						console.log(textStatus, errorThrown);
					}
				});
			});
			$(document).on("click",".ui-widget-overlay",function() { 
				if("bookmarks_dialog" in window && window.bookmarks_dialog.dialog("isOpen")){
					window.bookmarks_dialog.dialog("close");
				}
				if("search_history_dialog" in window && window.search_history_dialog.dialog("isOpen")){
					window.search_history_dialog.dialog("close");
				}
				if("chat_history_dialog" in window && window.chat_history_dialog.dialog("isOpen")){
					window.chat_history_dialog.dialog("close");
				}	
			});
		</script>
		<style>
			.ui-widget-overlay{
				opacity: .5;
			}
			.ui-dialog.bookmarks-modal .ui-dialog-content{
				padding: 20px 0;
			}
			.bookmarks_tabs_wrapper{
				display: flex;
			}
			.bookmark-tab{
				padding: 5px 15px;
				border-top: 1px solid #ccc;
				border-right: 1px solid #ccc;
				border-bottom: 1px solid #ccc;
				background: #e9e9e9;
				cursor: pointer;
				border-radius: 10px 10px 0px 0px;
				margin-bottom: -1px;
			}
			.bookmark-tab:nth-of-type(1){
				border-left: 1px solid #ccc;
				margin: 0 0 -1px 10px;
			}
			.bookmark-tab.active{
				background: #fff;
				cursor: initial;
				border-bottom: 1px solid #fff;
			}
			.bookmark-image{
				height: 100px;
				width: 100%;
				border: solid 5px transparent;
				display: block;
				margin: 10px 0 0 0;
				background: 50% / contain no-repeat;
			}
			#bookmark-account-wrapper, #bookmark-items-wrapper{
				flex-wrap: wrap;
				justify-content: stretch;
			}
			#bookmark-account-wrapper .bookmark-object, #bookmark-items-wrapper .bookmark-object{
				width: 215px;
				padding: 5px 5px;
				display: block;
				position: relative;
			}
			#bookmark-account-wrapper .bookmark-object .bookmark-object-border, #bookmark-items-wrapper .bookmark-object .bookmark-object-border{
				border: 1px solid #cccccc;
				padding: 10px;
				height: 100%;
			}
			#bookmark-account-wrapper .bookmark-object .partner_block_name, #bookmark-items-wrapper .bookmark-object .partner_block_name{
				font-weight: bold;
				padding: 0 0 10px 0;
				text-align: center;
			}
			#bookmark-account-wrapper .bookmark-object .partner_block_about, #bookmark-items-wrapper .bookmark-object .partner_block_about{
				font-size: 12px;
			}
			.bookmarks-content-wrapper{
				border-top: 1px solid #cccccc;
				padding: 10px 15px;
			}
			#bookmark-account-wrapper .bookmark-object .remove-bookmark, #bookmark-items-wrapper .bookmark-object .remove-bookmark{
				cursor: pointer;
				position: absolute;
				right: 15px;
				top: 15px;
				font-size: 11px;
			}
			.ui-dialog .bookmarks_wrapper, .ui-dialog .search_table_wrapper, .ui-dialog .conversation_table_wrapper{
				overflow-y: scroll;
				max-height: 400px;
			}
			.ui-dialog .item-company{
				padding: 15px 0;
				font-weight: bold;
			}
		</style>
		

            <script type="text/javascript">
                function recordVisit() {
                    // record page visit
                    var data = {
                        "command":"page_activity",
                        "type":"page_visit",
                        "aid":13818,
                        "i":3956159,
                        "m":0
                    }; 
                    $.ajax({
                        type: 'GET',
                        url: 'https://contentmx.com/b/page_commands.php',
                        data: data,
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true
                    });
                }
                
                // record click in page_activity
	            $(document).ready( function() {
	                
                    $('a').on('click', function() {
                        var href = $(this).attr('href');
                        var data = {
                            "command":"page_activity",
                            "type":"link_clicked",
                            "aid":13818,
                            "i":3956159,
                            "m":0,
                            "url":href
                        }; 
                        $.ajax({
                            type: 'GET',
                            url: 'https://contentmx.com/b/page_commands.php',
                            data: data,
                            xhrFields: {
                                withCredentials: true
                            },
                            crossDomain: true
                        });
                    });
                    
                    // register recordVisit
                    addPostVisitorCallback(recordVisit);
                    
                    // store the member_id for other loggers
                    window.known_member_id = 0;
                });
            </script>
        
<script>

		$(document).on("click", ".post-wrap .post-link.link_type_content_item", function(event){
			event.preventDefault();
			var this_button = this;
			var iid = $(this).attr("iid");
			link_display_router(this_button, iid);
		});

		function show_directory_item_modal(this_button, modal_html = "", display_middle = 0){
			//non-partner case
			var position_top = $(this_button).offset().top;
			var title_html = $(this_button).closest(".directory_item_block").find(".item_text_col .item_title").html();
			var image_url = $(this_button).closest(".directory_item_block").find(".item_image_col img").attr("src");
			var item_type_id = $(this_button).closest(".directory_item_block").attr("item_type_id");
			var description_html = $(this_button).closest(".directory_item_block").find(".description").html();
			var iid = $(this_button).closest(".directory_item_block").attr("iid");
			
			if(modal_html == ""){
				// do ajax command to get the link data if allowed to have it
				var data = { 
					"command": "get_partner_content_entry",
					"pa_id": 13818,
					"iid": iid,
					"mid": window.known_member_id,
					"update" : false,
					"ssid": window.search_session_id,
					"sssid": window.sub_search_session_id
				};
				$.ajax({
					type: "POST",
					url: "https://contentmx.com/b/partner_directory_commands.php",
					data: data,
					dataType: "json",
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function(data) {
						var is_item = false;
						if ("item" in data) {
							is_item = true;
							var download_url = data.item.url_original;
							var encoded_content_bundle = data.item.encoded_content;
							var link_url = data.item.url;
						}                         
										
						modal_html += "<h2>";
						modal_html += title_html;
						modal_html += "</h2>";
						modal_html += description_html;
				
						// if item_type_id is video, then is_item will be true
						if (item_type_id == window.content_type_video) {
							if (download_url.indexOf("youtube.") !== -1 || download_url.indexOf("youtu.be") !== -1) {
								var video_url = get_youtube_id(download_url);
								if(!video_url){
									modal_html += "<img src=\""+image_url+"\" class=\"modal_thumbnail\">";
								}else{
									modal_html += "<div class=\"plyr-player\"><iframe width=\"100%\" height=\"auto\" src=\"https://www.youtube.com/embed/"+video_url+"\" style=\"border:none;\"></iframe></div>";
								}
							}else if(download_url.indexOf("vimeo.com") !== -1){
								var video_url = get_vimeo_id(download_url);
								if(!video_url){
									modal_html += "<img src=\""+image_url+"\" class=\"modal_thumbnail\">";
								}else{
									modal_html += "<div class=\"plyr-player\"><iframe src=\"https://player.vimeo.com/video/"+video_url+"\" width=\"100%\" height=\"auto\" frameborder=\"0\" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>";
								}
							} 
						} else {
							modal_html += "<img src=\""+image_url+"\" class=\"modal_thumbnail\">";
						}
							
						//what button do we use?
						if (is_item) {
							if (item_type_id == window.content_type_url) {
								modal_html += "<div id=\"modal_content_action\" data-iid=\""+iid+"\" data-item-type-id=\""+item_type_id+"\"><a id=\"dir_item_link_button\" type=\"button\" href=\""+link_url+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">View Link</a></div>";
							} else if(item_type_id == window.content_type_picture || item_type_id == window.content_type_document) {
								modal_html += "<div id=\"modal_content_action\" data-iid=\""+iid+"\" data-item-type-id=\""+item_type_id+"\">";
								var pdf_test_string = download_url.toLowerCase();
								if (pdf_test_string.indexOf(".pdf") != -1) {
									modal_html += "<a id=\"dir_item_view_doc_button\" type=\"button\" href=\""+encoded_content_bundle+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">View</a> ";
									modal_html += "<a id=\"dir_item_download_button\" type=\"button\" href=\""+encoded_content_bundle+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">Download</a>";
								}else{
									modal_html += "<a id=\"dir_item_download_button\" type=\"button\" href=\""+download_url+"\" target=\"_blank\" style=\"color:#fff;\" class=\"btn btn-primary\" data-iid=\""+iid+"\">Download</a>";
								}
								
								modal_html += "</div>";
							}
						} else {
							if (item_type_id == window.content_type_url) {
								modal_html += "<div id=\"modal_content_action\" data-iid=\""+iid+"\" data-item-type-id=\""+item_type_id+"\"><a type=\"button\" style=\"color:#fff;\" class=\"btn btn-primary\" onclick=\"sign_in()\" data-iid=\""+iid+"\">View Link</a></div>";
							} else if(item_type_id == window.content_type_picture || item_type_id == window.content_type_document) {
								modal_html += "<div id=\"modal_content_action\" data-iid=\""+iid+"\" data-item-type-id=\""+item_type_id+"\"><a type=\"button\" style=\"color:#fff;\" class=\"btn btn-primary\" onclick=\"sign_in()\" data-iid=\""+iid+"\">Download</a></div>";
							}
						}
						
						$("#item_display_modal #modal_content").html(modal_html);
						var offset = $(document).scrollTop();
						var viewportHeight = $(window).height();
						var modal = $("#item_display_modal");
						var position = (offset  + (viewportHeight/2)) - (modal.outerHeight()/2);
						if (modal.outerHeight() > viewportHeight) {
							position = offset+5;
						}
						if(display_middle == 1){
							$(modal).css({"top":"50%", "-webkit-transform": "translateY(-50%)", "-ms-transform": "translateY(-50%)", "transform": "translateY(-50%)", "display":"block", "width":"", "height":"", "max-width":"", "position":""});
						}else{
							$(modal).css({"top": position_top-200, "display":"block", "width":"", "height":"", "max-width":"", "position":""});
						}
						
						var plyr_args = {instance_id: iid, account_id: 13818, member_id: window.known_member_id};
						search_and_setup_plyr_player($("#item_display_modal #modal_content"),"#item_display_modal #modal_content", "directory", plyr_args);

						$("#item_display_modal_underlay").show();
					},
					error: function(jqXHR, textStatus, errorThrown) {
						console.log(textStatus, errorThrown);
					}
				});
			}else{
				//iframe case
				$("#item_display_modal #modal_content").html(modal_html);
				var offset = $(document).scrollTop();
				var viewportHeight = $(window).height();
				var modal = $("#item_display_modal");
				var position = (offset  + (viewportHeight/2)) - (modal.outerHeight()/2);
				if (modal.outerHeight() > viewportHeight) {
					position = offset+5;
				}
				$("#item_display_modal_underlay").show();
				$(modal).css({"top": "0", "width":"100%", "height":"100%", "max-width":"1400px", "display":"block", "position":"fixed"});
			}
		}

		function link_display_router(this_button, iid){ //ktg
			var data = { 
				"command": "get_partner_content_entry_url",
				"pa_id": 13818,
				"iid": iid
			};
			$.ajax({
				type: "POST",
				url: "https://contentmx.com/b/partner_directory_commands.php",
				data: data,
				dataType: "json",
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function(data) {
					console.log(data.item_url);
					var item_url = "";
					var can_embed = 0;
					if("item_url" in data){
						if(data.item_url != ""){
							item_url = data.item_url;
						}
					}
					if("can_embed" in data){
						can_embed = data.can_embed;
					}

					if(item_url != ""){
						if(can_embed == 1){
						var cmx_iframe = display_link_in_frame(item_url);
						show_directory_item_modal(this_button, cmx_iframe)
						}else{
							window.open(item_url, "_blank");
						}
					}else{
						alert("Unable to fetch link.");
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					alert("Unable to fetch link.");
				}
			});
		}

        function display_link_in_frame(url){
            var cmx_iframe = "<iframe id=\"cmx_inline_link_frame\" width=\"300\" height=\"200\" src=\""+url+"\"></iframe>";
            return cmx_iframe;
        }

	</script>
	    </body>
</html>	 